@@@package.json
{
  "name": "pet-fish-marketplace",
  "private": true,
  "version": "1.0.0",
  "scripts": {
    "dev": "concurrently \"npm run dev --prefix backend\" \"npm run dev --prefix frontend\"",
    "dev:backend": "npm run dev --prefix backend",
    "dev:frontend": "npm run dev --prefix frontend",
    "build": "npm --prefix backend run build && npm --prefix frontend run build"
  },
  "devDependencies": {
    "concurrently": "^9.2.1"
  }
}

@@@

@@@backend\package.json
{
  "name": "backend",
  "version": "1.0.0",
  "main": "dist/server.js",
  "type": "commonjs",
  "scripts": {
    "dev": "ts-node-dev --respawn --transpile-only src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js"
  },
  "dependencies": {
    "better-sqlite3": "^11.0.0",
    "cors": "^2.8.5",
    "express": "^4.19.2",
    "multer": "^2.0.2",
    "sharp": "^0.34.5",
    "zod": "^3.24.0"
  },
  "devDependencies": {
    "@types/cors": "^2.8.17",
    "@types/express": "^4.17.21",
    "@types/multer": "^2.0.0",
    "@types/node": "^20.0.0",
    "ts-node-dev": "^2.0.0",
    "typescript": "^5.5.4"
  }
}

@@@

@@@backend\tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "rootDir": "src",
    "outDir": "dist",
    "strict": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "skipLibCheck": true
  }
}

@@@

@@@backend\scripts\post-dummy-listings.ps1
$ErrorActionPreference = "Stop"

$API = "http://localhost:3001"

$MY_COUNT = 8
$OTHER_COUNT = 40

$species = @("Guppy","Betta","Discus","Angelfish","Neon Tetra","Cherry Shrimp","Corydoras")
$locations = @("Brisbane","Gold Coast","Sydney","Melbourne","Perth","Adelaide")
$categories = @("Fish","Shrimp","Snails","Plants","Equipment")

$myTokens = @{}

# Track used commons files across the whole seeding run (reduces repeats across listings)
$script:UsedCommonsFiles = New-Object 'System.Collections.Generic.HashSet[string]'

function RandFrom($arr) {
  return $arr | Get-Random
}

function GetStockImages(
  [string]$species,
  [int]$min = 1,
  [int]$max = 3
) {
  if ($max -lt $min) { $max = $min }
  $count = Get-Random -Minimum $min -Maximum ($max + 1)

  # Candidate search terms per species (not filenames) so we can fetch real, existing files.
  $queryMap = @{
    "Guppy"         = @("Poecilia reticulata", "guppy aquarium fish")
    "Betta"         = @("Betta splendens", "Siamese fighting fish")
    "Discus"        = @("Symphysodon discus", "discus fish aquarium")
    "Angelfish"     = @("Pterophyllum scalare", "freshwater angelfish")
    "Neon Tetra"    = @("Paracheirodon innesi", "neon tetra aquarium")
    "Cherry Shrimp" = @("Neocaridina davidi", "red cherry shrimp aquarium")
    "Corydoras"     = @("Corydoras", "cory catfish aquarium")
  }

  $fallbackQueries = @("aquarium fish", "tropical fish", "freshwater fish", "aquarium shrimp", "aquarium plant")

  $queries = $queryMap[$species]
  if (-not $queries) { $queries = $fallbackQueries }

  function GetCommonsImageCandidates([string]$q, [int]$limit = 30) {
    # Uses Wikipedia API to search Commons (via "commonswiki")
    $u = "https://en.wikipedia.org/w/api.php" +
         "?action=query" +
         "&format=json" +
         "&origin=*" +
         "&generator=search" +
         "&gsrsearch=" + [uri]::EscapeDataString($q + " filetype:bitmap") +
         "&gsrlimit=" + $limit +
         "&gsrnamespace=6" +  # File:
         "&prop=imageinfo" +
         "&iiprop=url" +
         "&iilimit=1" +
         "&iiurlwidth=1600"

    try {
      $r = Invoke-RestMethod -Uri $u -Method GET -TimeoutSec 25
      if (-not $r.query.pages) { return @() }

      $out = New-Object System.Collections.Generic.List[object]
      foreach ($p in $r.query.pages.PSObject.Properties.Value) {
        $ii = $p.imageinfo
        if (-not $ii -or $ii.Count -lt 1) { continue }
        $info = $ii[0]

        # Prefer the "thumburl" (width-limited) for reliability; use original url if thumb missing.
        $url = $info.thumburl
        if (-not $url) { $url = $info.url }
        if (-not $url) { continue }

        # Use canonical file title to dedupe globally ("File:Something.jpg")
        $title = $p.title
        if (-not $title) { continue }

        # Filter out obvious non-photo formats sometimes returned (svg) even though bitmap filter helps.
        if ($url -match "\.svg($|\?)") { continue }

        $out.Add([pscustomobject]@{ title = $title; url = $url }) | Out-Null
      }
      return $out
    } catch {
      return @()
    }
  }

  # Build a candidate pool from multiple queries
  $pool = New-Object System.Collections.Generic.List[object]
  foreach ($q in $queries) {
    $c = GetCommonsImageCandidates $q 40
    foreach ($x in $c) { $pool.Add($x) | Out-Null }
    if ($pool.Count -ge 80) { break }
  }

  # If we still have too few, add fallbacks
  if ($pool.Count -lt ($count * 4)) {
    foreach ($q in $fallbackQueries) {
      $c = GetCommonsImageCandidates $q 40
      foreach ($x in $c) { $pool.Add($x) | Out-Null }
      if ($pool.Count -ge 120) { break }
    }
  }

  # Deduplicate pool by title
  $byTitle = @{}
  foreach ($x in $pool) {
    if (-not $byTitle.ContainsKey($x.title)) { $byTitle[$x.title] = $x.url }
  }

  $titles = @($byTitle.Keys)
  if ($titles.Count -eq 0) {
    # As a last resort (offline / API fail), return picsum unique seeds
    $urls = @()
    for ($i = 0; $i -lt $count; $i++) {
      $seed = [guid]::NewGuid().ToString()
      $urls += "https://picsum.photos/seed/$seed/1600/1200"
    }
    return ,$urls
  }

  # Choose unique images within the listing, preferring never-used globally
  $chosen = New-Object System.Collections.Generic.List[string]

  # First pass: pick globally-unused
  $shuffled = $titles | Get-Random -Count ([Math]::Min($titles.Count, 999999))
  foreach ($t in $shuffled) {
    if ($chosen.Count -ge $count) { break }
    if ($script:UsedCommonsFiles.Contains($t)) { continue }
    $script:UsedCommonsFiles.Add($t) | Out-Null
    $chosen.Add($byTitle[$t]) | Out-Null
  }

  # Second pass: if not enough, allow repeats globally but still unique within listing
  if ($chosen.Count -lt $count) {
    foreach ($t in $shuffled) {
      if ($chosen.Count -ge $count) { break }
      $u = $byTitle[$t]
      if ($chosen.Contains($u)) { continue }
      $chosen.Add($u) | Out-Null
    }
  }

  # Final guard: if still short, fill with unique picsum
  while ($chosen.Count -lt $count) {
    $seed = [guid]::NewGuid().ToString()
    $chosen.Add("https://picsum.photos/seed/$seed/1600/1200") | Out-Null
  }

  return ,@($chosen.ToArray())
}

function NewListingBody([bool]$isMine) {
  $sp = RandFrom $species
  $cat = RandFrom $categories
  $price = Get-Random -Minimum 5 -Maximum 250

  $contact = if ($isMine) { "DM me here" } else { "SMS preferred" }

  $imgs = GetStockImages $sp 1 5

  return @{
    title       = "$sp - healthy stock"
    category    = $cat
    species     = $sp
    priceCents  = [int]($price * 100)
    location    = RandFrom $locations
    description = "Healthy, well-kept stock. Pickup preferred."
    contact     = $contact
    images      = $imgs     # <-- already an array
  }
}

Write-Host "Posting MY listings..."
for ($i = 1; $i -le $MY_COUNT; $i++) {
  $bodyObj = NewListingBody $true
  $json = $bodyObj | ConvertTo-Json -Depth 10

  # Optional sanity check
  # Write-Host $json

  $res = Invoke-RestMethod `
    -Uri ($API + "/api/listings") `
    -Method POST `
    -ContentType "application/json" `
    -Body $json

  $myTokens[$res.id] = $res.ownerToken
}

Write-Host "Posting OTHER listings..."
for ($i = 1; $i -le $OTHER_COUNT; $i++) {
  $bodyObj = NewListingBody $false
  $json = $bodyObj | ConvertTo-Json -Depth 10

  Invoke-RestMethod `
    -Uri ($API + "/api/listings") `
    -Method POST `
    -ContentType "application/json" `
    -Body $json | Out-Null
}

Write-Host ""
Write-Host ("Done. Seeded " + $MY_COUNT + " mine + " + $OTHER_COUNT + " others.")
Write-Host ""

$tokenJson = ($myTokens | ConvertTo-Json -Compress)

Write-Host "=== PASTE THIS INTO YOUR BROWSER CONSOLE ==="
Write-Host "localStorage.setItem('fish_owner_tokens_v1', '$tokenJson');"
Write-Host "=========================================="

@@@

@@@backend\src\db.ts
// backend/src/db.ts
import fs = require("fs");
import path = require("path");
import Database = require("better-sqlite3");
import crypto = require("crypto");

const DATA_DIR = path.join(process.cwd(), "data");
const DB_PATH = path.join(DATA_DIR, "app.db");

console.log("[db] cwd =", process.cwd());
console.log("[db] DB_PATH =", DB_PATH);

// Lifecycle status (visibility / workflow)
export type ListingStatus = "draft" | "pending" | "active" | "paused" | "expired" | "deleted";

// Outcome resolution (what happened)
export type ListingResolution = "none" | "sold";

export type ListingRow = {
  id: string;
  owner_token: string;
  title: string;
  category: string;
  species: string;
  price_cents: number;
  location: string;
  description: string;
  contact: string | null;
  image_url: string | null;

  status: ListingStatus;

  expires_at: string | null;
  resolution: ListingResolution;
  resolved_at: string | null;

  created_at: string;
  updated_at: string;
  deleted_at: string | null;
};

export type ListingImageRow = {
  id: string;
  listing_id: string;
  url: string;
  thumb_url: string | null;
  medium_url: string | null;
  sort_order: number;
};

function ensureDir(p: string) {
  if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true });
}

function hasTable(db: Database.Database, name: string) {
  const row = db.prepare(`SELECT name FROM sqlite_master WHERE type='table' AND name=?`).get(name) as any;
  return !!row;
}

function hasColumn(db: Database.Database, table: string, col: string) {
  const cols = db.prepare(`PRAGMA table_info(${table})`).all() as any[];
  return cols.some((c) => String(c.name) === col);
}

export function openDb() {
  ensureDir(DATA_DIR);
  const db = new Database(DB_PATH);

  db.pragma("journal_mode = WAL");
  db.pragma("foreign_keys = ON");

  // Base schema (fresh DBs)
  db.exec(`
    CREATE TABLE IF NOT EXISTS listings (
      id TEXT PRIMARY KEY,
      owner_token TEXT NOT NULL,
      title TEXT NOT NULL,
      category TEXT NOT NULL DEFAULT 'Fish',
      species TEXT NOT NULL,
      price_cents INTEGER NOT NULL,
      location TEXT NOT NULL,
      description TEXT NOT NULL,
      contact TEXT,
      image_url TEXT,

      status TEXT NOT NULL DEFAULT 'active',

      expires_at TEXT,
      resolution TEXT NOT NULL DEFAULT 'none',
      resolved_at TEXT,

      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL,
      deleted_at TEXT
    );

    CREATE TABLE IF NOT EXISTS listing_images (
      id TEXT PRIMARY KEY,
      listing_id TEXT NOT NULL,
      url TEXT NOT NULL,
      thumb_url TEXT,
      medium_url TEXT,
      sort_order INTEGER NOT NULL DEFAULT 0,
      FOREIGN KEY(listing_id) REFERENCES listings(id) ON DELETE CASCADE
    );

    CREATE INDEX IF NOT EXISTS idx_listings_created_at ON listings(created_at);
    CREATE INDEX IF NOT EXISTS idx_listings_updated_at ON listings(updated_at);
    CREATE INDEX IF NOT EXISTS idx_listings_species ON listings(species);
    CREATE INDEX IF NOT EXISTS idx_listings_price ON listings(price_cents);
    CREATE INDEX IF NOT EXISTS idx_listings_category ON listings(category);
    CREATE INDEX IF NOT EXISTS idx_listings_owner_token ON listings(owner_token);
    CREATE INDEX IF NOT EXISTS idx_listings_status ON listings(status);
    CREATE INDEX IF NOT EXISTS idx_listings_resolution ON listings(resolution);
    CREATE INDEX IF NOT EXISTS idx_listings_expires_at ON listings(expires_at);

    CREATE INDEX IF NOT EXISTS idx_listing_images_listing_id ON listing_images(listing_id);
  `);

  // -------- migrations for older DBs --------
  if (!hasColumn(db, "listings", "owner_token")) db.exec(`ALTER TABLE listings ADD COLUMN owner_token TEXT`);
  if (!hasColumn(db, "listings", "category")) db.exec(`ALTER TABLE listings ADD COLUMN category TEXT NOT NULL DEFAULT 'Fish'`);
  if (!hasColumn(db, "listings", "contact")) db.exec(`ALTER TABLE listings ADD COLUMN contact TEXT`);
  if (!hasColumn(db, "listings", "image_url")) db.exec(`ALTER TABLE listings ADD COLUMN image_url TEXT`);

  if (!hasColumn(db, "listings", "status")) db.exec(`ALTER TABLE listings ADD COLUMN status TEXT NOT NULL DEFAULT 'active'`);
  if (!hasColumn(db, "listings", "updated_at")) db.exec(`ALTER TABLE listings ADD COLUMN updated_at TEXT`);
  if (!hasColumn(db, "listings", "deleted_at")) db.exec(`ALTER TABLE listings ADD COLUMN deleted_at TEXT`);

  // NEW columns
  if (!hasColumn(db, "listings", "expires_at")) db.exec(`ALTER TABLE listings ADD COLUMN expires_at TEXT`);
  if (!hasColumn(db, "listings", "resolution")) db.exec(`ALTER TABLE listings ADD COLUMN resolution TEXT NOT NULL DEFAULT 'none'`);
  if (!hasColumn(db, "listings", "resolved_at")) db.exec(`ALTER TABLE listings ADD COLUMN resolved_at TEXT`);

  if (!hasTable(db, "listing_images")) {
    db.exec(`
      CREATE TABLE IF NOT EXISTS listing_images (
        id TEXT PRIMARY KEY,
        listing_id TEXT NOT NULL,
        url TEXT NOT NULL,
        thumb_url TEXT,
        medium_url TEXT,
        sort_order INTEGER NOT NULL DEFAULT 0,
        FOREIGN KEY(listing_id) REFERENCES listings(id) ON DELETE CASCADE
      );
      CREATE INDEX IF NOT EXISTS idx_listing_images_listing_id ON listing_images(listing_id);
    `);
  } else {
    if (!hasColumn(db, "listing_images", "thumb_url")) db.exec(`ALTER TABLE listing_images ADD COLUMN thumb_url TEXT`);
    if (!hasColumn(db, "listing_images", "medium_url")) db.exec(`ALTER TABLE listing_images ADD COLUMN medium_url TEXT`);
  }

  // ---- backfills ----
  // owner_token
  db.exec(`
    UPDATE listings
    SET owner_token = COALESCE(NULLIF(owner_token, ''), '')
  `);

  const missingTokens = db
    .prepare(`SELECT id FROM listings WHERE owner_token IS NULL OR owner_token = ''`)
    .all() as { id: string }[];

  const updTok = db.prepare(`UPDATE listings SET owner_token = ? WHERE id = ?`);
  for (const r of missingTokens) updTok.run(crypto.randomUUID(), r.id);

  // updated_at: default to created_at if missing/empty
  db.exec(`
    UPDATE listings
    SET updated_at = COALESCE(NULLIF(updated_at, ''), created_at)
    WHERE updated_at IS NULL OR updated_at = ''
  `);

  // Normalize legacy statuses: if DB previously had 'sold' status, convert into resolution=sold + keep status active.
  db.exec(`
    UPDATE listings
    SET
      resolution = 'sold',
      resolved_at = COALESCE(resolved_at, updated_at),
      status = 'active'
    WHERE lower(status) = 'sold'
  `);

  // If old DB had resolution='solved', map it to 'sold' (solved is removed from the product)
  db.exec(`
    UPDATE listings
    SET
      resolution = 'sold',
      resolved_at = COALESCE(resolved_at, updated_at)
    WHERE lower(resolution) = 'solved'
  `);

  // status: default to active if empty (safety)
  db.exec(`
    UPDATE listings
    SET status = COALESCE(NULLIF(status, ''), 'active')
    WHERE status IS NULL OR status = ''
  `);

  // resolution: default to none if empty (safety) and clamp unknowns to none
  db.exec(`
    UPDATE listings
    SET resolution = COALESCE(NULLIF(resolution, ''), 'none')
    WHERE resolution IS NULL OR resolution = ''
  `);

  db.exec(`
    UPDATE listings
    SET resolution = 'none'
    WHERE lower(resolution) NOT IN ('none', 'sold')
  `);

  // expires_at: backfill to created_at + 30 days if missing
  db.exec(`
    UPDATE listings
    SET expires_at = COALESCE(expires_at, datetime(created_at, '+30 days'))
    WHERE expires_at IS NULL OR expires_at = ''
  `);

  // deleted_at: ensure NULL unless status=deleted
  db.exec(`
    UPDATE listings
    SET deleted_at = NULL
    WHERE status <> 'deleted'
  `);

  // backfill listing_images from legacy image_url if no images exist
  const listings = db.prepare(`SELECT id, image_url FROM listings`).all() as { id: string; image_url: string | null }[];

  const countImgs = db.prepare(`SELECT COUNT(*) as c FROM listing_images WHERE listing_id = ?`);
  const insImg = db.prepare(
    `INSERT INTO listing_images (id, listing_id, url, thumb_url, medium_url, sort_order)
     VALUES (?, ?, ?, ?, ?, ?)`
  );

  for (const l of listings) {
    const c = (countImgs.get(l.id) as any).c as number;
    if (c === 0 && l.image_url) {
      insImg.run(crypto.randomUUID(), l.id, l.image_url, l.image_url, l.image_url, 0);
    }
  }

  // If existing rows in listing_images lack thumb/medium, backfill to url (safe fallback)
  db.exec(`
    UPDATE listing_images
    SET
      thumb_url  = COALESCE(thumb_url, url),
      medium_url = COALESCE(medium_url, url)
  `);

  // re-ensure indexes
  db.exec(`
    CREATE INDEX IF NOT EXISTS idx_listings_owner_token ON listings(owner_token);
    CREATE INDEX IF NOT EXISTS idx_listings_category ON listings(category);
    CREATE INDEX IF NOT EXISTS idx_listings_status ON listings(status);
    CREATE INDEX IF NOT EXISTS idx_listings_resolution ON listings(resolution);
    CREATE INDEX IF NOT EXISTS idx_listings_expires_at ON listings(expires_at);
    CREATE INDEX IF NOT EXISTS idx_listings_updated_at ON listings(updated_at);
    CREATE INDEX IF NOT EXISTS idx_listing_images_listing_id ON listing_images(listing_id);
  `);

  return db;
}

@@@

@@@backend\src\server.ts
// backend/src/server.ts
import express from "express";
import cors from "cors";
import { z } from "zod";
import { openDb, type ListingRow, type ListingStatus, type ListingResolution } from "./db";
import crypto from "crypto";
import multer from "multer";
import path from "path";
import fs from "fs";
import sharp from "sharp";

const app = express();
const db = openDb();

app.use(cors({ origin: process.env.CORS_ORIGIN ?? "http://localhost:5173" }));
app.use(express.json());

app.get("/health", (_req, res) => res.json({ ok: true }));

// ---------- Uploads ----------
const UPLOADS_DIR = path.join(process.cwd(), "data", "uploads");
if (!fs.existsSync(UPLOADS_DIR)) fs.mkdirSync(UPLOADS_DIR, { recursive: true });

// Serve uploaded files
app.use("/uploads", express.static(UPLOADS_DIR));

function extFromMimetype(mimetype: string) {
  if (mimetype === "image/jpeg") return ".jpg";
  if (mimetype === "image/png") return ".png";
  if (mimetype === "image/webp") return ".webp";
  return "";
}

type ImageAsset = { url: string; thumbUrl: string; mediumUrl: string };

const upload = multer({
  storage: multer.diskStorage({
    destination: (_req, _file, cb) => cb(null, UPLOADS_DIR),
    filename: (_req, file, cb) => {
      const ext = extFromMimetype(file.mimetype);
      const name = crypto.randomUUID() + ext;
      cb(null, name);
    },
  }),
  limits: {
    fileSize: 6 * 1024 * 1024, // 6MB
  },
  fileFilter: (_req, file, cb) => {
    const ok = ["image/jpeg", "image/png", "image/webp"].includes(file.mimetype);
    cb(ok ? null : new Error("Only JPG/PNG/WebP images are allowed"), ok);
  },
});

async function makeDerivatives(absPath: string, baseNameNoExt: string): Promise<{ thumb: string; medium: string }> {
  const thumbName = `${baseNameNoExt}_thumb.webp`;
  const mediumName = `${baseNameNoExt}_med.webp`;

  const thumbAbs = path.join(UPLOADS_DIR, thumbName);
  const medAbs = path.join(UPLOADS_DIR, mediumName);

  await sharp(absPath).rotate().resize({ width: 320, withoutEnlargement: true }).webp({ quality: 72 }).toFile(thumbAbs);
  await sharp(absPath).rotate().resize({ width: 960, withoutEnlargement: true }).webp({ quality: 82 }).toFile(medAbs);

  return { thumb: `/uploads/${thumbName}`, medium: `/uploads/${mediumName}` };
}

// Upload endpoint
app.post("/api/uploads", upload.single("image"), async (req, res) => {
  try {
    if (!req.file) return res.status(400).json({ error: "No image uploaded" });

    const originalUrl = `/uploads/${req.file.filename}`;
    const abs = path.join(UPLOADS_DIR, req.file.filename);

    const base = path.parse(req.file.filename).name;
    const d = await makeDerivatives(abs, base);

    const out: ImageAsset = {
      url: originalUrl,
      thumbUrl: d.thumb,
      mediumUrl: d.medium,
    };

    return res.status(201).json(out);
  } catch (e: any) {
    const msg = e?.message ?? "Upload error";
    return res.status(400).json({ error: msg });
  }
});

// Helpful error handler for multer/fileFilter errors
app.use((err: any, _req: any, res: any, next: any) => {
  if (!err) return next();
  const msg = typeof err?.message === "string" ? err.message : "Upload error";
  return res.status(400).json({ error: msg });
});

// ---------- Ownership helper ----------
function requireOwner(req: express.Request, row: any) {
  const token = String(req.header("x-owner-token") ?? "").trim();
  return token && row?.owner_token && token === row.owner_token;
}

// ---------- Lifecycle + resolution model ----------
const StatusSchema = z.enum(["draft", "pending", "active", "paused", "expired", "deleted"]);
const ResolutionSchema = z.enum(["none", "sold"]);

const PUBLIC_LIFECYCLE: ListingStatus[] = ["active", "pending"];

function addDaysIso(isoNow: string, days: number) {
  const d = new Date(isoNow);
  d.setUTCDate(d.getUTCDate() + days);
  return d.toISOString();
}

function nowIso() {
  return new Date().toISOString();
}

// Expire pass (run opportunistically)
function runAutoExpirePass() {
  const now = nowIso();
  db.prepare(
    `
    UPDATE listings
    SET status='expired', updated_at=?
    WHERE status <> 'deleted'
      AND status <> 'expired'
      AND expires_at IS NOT NULL
      AND expires_at <> ''
      AND expires_at < ?
  `
  ).run(now, now);
}

// ---------- Listings ----------
const ImageAssetSchema = z.object({
  url: z.string().min(1),
  thumbUrl: z.string().min(1),
  mediumUrl: z.string().min(1),
});

const ImagesInputSchema = z.array(z.union([z.string(), ImageAssetSchema])).max(6).optional().default([]);

function normalizeImages(input: (string | ImageAsset)[]): ImageAsset[] {
  return (input ?? []).map((x) => {
    if (typeof x === "string") return { url: x, thumbUrl: x, mediumUrl: x };
    return x;
  });
}

const CreateListingSchema = z.object({
  title: z.string().min(3).max(80),
  category: z.enum(["Fish", "Shrimp", "Snails", "Plants", "Equipment"]).default("Fish"),
  species: z.string().min(2).max(60),
  priceCents: z.number().int().min(0).max(5_000_000),
  location: z.string().min(2).max(80),
  description: z.string().min(1).max(1000),
  contact: z.string().max(200).optional().nullable(),

  images: ImagesInputSchema,

  // legacy optional single image
  imageUrl: z.string().optional().nullable(),

  // optional for future; if provided, must be draft or active
  status: z.enum(["draft", "active"]).optional(),
});

const UpdateListingSchema = z.object({
  title: z.string().min(3).max(80).optional(),
  category: z.enum(["Fish", "Shrimp", "Snails", "Plants", "Equipment"]).optional(),
  species: z.string().min(2).max(60).optional(),
  priceCents: z.number().int().min(0).max(5_000_000).optional(),
  location: z.string().min(2).max(80).optional(),
  description: z.string().min(1).max(1000).optional(),
  contact: z.string().max(200).nullable().optional(),

  images: ImagesInputSchema.optional(),
  imageUrl: z.string().nullable().optional(), // legacy
});

app.post("/api/listings", (req, res) => {
  runAutoExpirePass();

  const parsed = CreateListingSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: "Invalid payload", details: parsed.error.flatten() });
  }

  const id = crypto.randomUUID();
  const now = nowIso();
  const ownerToken = crypto.randomUUID();

  const ttlDays = Number(process.env.LISTING_TTL_DAYS ?? "30");
  const expiresAt = addDaysIso(now, Number.isFinite(ttlDays) && ttlDays > 0 ? ttlDays : 30);

  // Today: default to ACTIVE.
  // Future: set REQUIRE_APPROVAL=1 to default to PENDING.
  const requireApproval = String(process.env.REQUIRE_APPROVAL ?? "").trim() === "1";

  const { title, category, species, priceCents, location, description, contact, images, imageUrl } = parsed.data;

  const requestedStatus = parsed.data.status;
  const status: ListingStatus = requestedStatus === "draft" ? "draft" : requireApproval ? "pending" : "active";

  db.prepare(
    `INSERT INTO listings (
        id, owner_token, title, category, species, price_cents, location, description, contact, image_url,
        status, expires_at, resolution, resolved_at, created_at, updated_at, deleted_at
     ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`
  ).run(
    id,
    ownerToken,
    title,
    category,
    species,
    priceCents,
    location,
    description,
    contact ?? null,
    imageUrl ?? null,
    status,
    expiresAt,
    "none",
    null,
    now,
    now,
    null
  );

  const insertImg = db.prepare(
    `INSERT INTO listing_images (id, listing_id, url, thumb_url, medium_url, sort_order)
     VALUES (?, ?, ?, ?, ?, ?)`
  );

  const normalized = normalizeImages(images ?? []);
  const fallback = imageUrl ? [{ url: imageUrl, thumbUrl: imageUrl, mediumUrl: imageUrl }] : [];
  const finalImages = (normalized.length ? normalized : fallback).slice(0, 6);

  finalImages.forEach((img, idx) => {
    insertImg.run(crypto.randomUUID(), id, img.url, img.thumbUrl, img.mediumUrl, idx);
  });

  const row = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(id);
  return res.status(201).json({ ...mapListing(row!), ownerToken });
});

app.get("/api/listings", (req, res) => {
  runAutoExpirePass();

  const q = String(req.query.q ?? "").trim().toLowerCase();
  const species = String(req.query.species ?? "").trim().toLowerCase();
  const category = String(req.query.category ?? "").trim();

  const min = req.query.minPriceCents ? Number(req.query.minPriceCents) : undefined;
  const max = req.query.maxPriceCents ? Number(req.query.maxPriceCents) : undefined;

  const sort = String(req.query.sort ?? "newest");

  const limitRaw = req.query.limit !== undefined ? Number(req.query.limit) : undefined;
  const limit = Number.isFinite(limitRaw) ? Math.max(1, Math.min(200, Math.floor(limitRaw!))) : 24;

  const offsetRaw = req.query.offset !== undefined ? Number(req.query.offset) : undefined;
  const offset = Number.isFinite(offsetRaw) ? Math.max(0, Math.floor(offsetRaw!)) : 0;

  const where: string[] = [];
  const params: any[] = [];

  // Public browse:
  // - lifecycle in active/pending
  // - not resolved (sold hidden from browse)
  where.push(`status IN ('active','pending')`);
  where.push(`resolution = 'none'`);

  if (q) {
    where.push("(lower(title) LIKE ? OR lower(description) LIKE ? OR lower(location) LIKE ? OR lower(species) LIKE ?)");
    const pat = `%${q}%`;
    params.push(pat, pat, pat, pat);
  }
  if (species) {
    where.push("lower(species) = ?");
    params.push(species);
  }
  if (category) {
    where.push("category = ?");
    params.push(category);
  }
  if (Number.isFinite(min)) {
    where.push("price_cents >= ?");
    params.push(min);
  }
  if (Number.isFinite(max)) {
    where.push("price_cents <= ?");
    params.push(max);
  }

  const whereSql = where.length ? `WHERE ${where.join(" AND ")}` : "";

  const totalRow = db.prepare(`SELECT COUNT(*) as c FROM listings ${whereSql}`).get(...params) as any;
  const total = Number(totalRow?.c ?? 0);

  let orderBy = "created_at DESC, id DESC";
  if (sort === "price_asc") orderBy = "price_cents ASC, created_at DESC, id DESC";
  if (sort === "price_desc") orderBy = "price_cents DESC, created_at DESC, id DESC";

  const sql = `
    SELECT * FROM listings
    ${whereSql}
    ORDER BY ${orderBy}
    LIMIT ? OFFSET ?
  `;

  const rows = db.prepare(sql).all(...params, limit, offset) as (ListingRow & any)[];

  return res.json({
    items: rows.map(mapListing),
    total,
    limit,
    offset,
  });
});

app.get("/api/listings/:id", (req, res) => {
  runAutoExpirePass();

  const id = req.params.id;
  const row = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(id);
  if (!row) return res.status(404).json({ error: "Not found" });

  const isOwner = requireOwner(req, row);

  const status = String(row.status ?? "active") as ListingStatus;
  const resolution = String(row.resolution ?? "none") as ListingResolution;

  // Deleted: never visible unless owner
  if (!isOwner && status === "deleted") return res.status(404).json({ error: "Not found" });

  // Public if active/pending OR resolved (sold).
  // (Paused/draft/expired remain owner-only)
  const isPublic = PUBLIC_LIFECYCLE.includes(status) || resolution !== "none";
  if (!isOwner && !isPublic) return res.status(404).json({ error: "Not found" });

  return res.json(mapListing(row));
});

app.patch("/api/listings/:id", (req, res) => {
  runAutoExpirePass();

  const id = req.params.id;
  const row = db.prepare<(ListingRow & any)>("SELECT * FROM listings WHERE id = ?").get(id);
  if (!row) return res.status(404).json({ error: "Not found" });

  if (!requireOwner(req, row)) return res.status(403).json({ error: "Not owner" });

  const parsed = UpdateListingSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({ error: "Invalid payload", details: parsed.error.flatten() });
  }
  const p = parsed.data;

  const currentStatus = String(row.status ?? "active") as ListingStatus;

  // Disallow edits if deleted/expired (you can loosen this later if you want)
  if (currentStatus === "deleted") return res.status(400).json({ error: "Listing is deleted" });
  if (currentStatus === "expired") return res.status(400).json({ error: "Listing is expired" });

  const sets: string[] = [];
  const params: any[] = [];

  const map: Record<string, any> = {
    title: p.title,
    category: p.category,
    species: p.species,
    price_cents: p.priceCents,
    location: p.location,
    description: p.description,
    contact: p.contact,
    image_url: p.imageUrl,
  };

  for (const [k, v] of Object.entries(map)) {
    if (v !== undefined) {
      sets.push(`${k} = ?`);
      params.push(v);
    }
  }

  const now = nowIso();
  sets.push(`updated_at = ?`);
  params.push(now);

  if (sets.length) {
    db.prepare(`UPDATE listings SET ${sets.join(", ")} WHERE id = ?`).run(...params, id);
  }

  if (p.images) {
    db.prepare(`DELETE FROM listing_images WHERE listing_id = ?`).run(id);
    const ins = db.prepare(
      `INSERT INTO listing_images (id, listing_id, url, thumb_url, medium_url, sort_order)
       VALUES (?, ?, ?, ?, ?, ?)`
    );

    const normalized = normalizeImages(p.images ?? []).slice(0, 6);
    normalized.forEach((img, idx) => ins.run(crypto.randomUUID(), id, img.url, img.thumbUrl, img.mediumUrl, idx));
  }

  const updated = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(id);
  return res.json(mapListing(updated!));
});

app.delete("/api/listings/:id", (req, res) => {
  runAutoExpirePass();

  const id = req.params.id;
  const row = db.prepare<(ListingRow & any)>("SELECT * FROM listings WHERE id = ?").get(id);
  if (!row) return res.status(404).json({ error: "Not found" });

  if (!requireOwner(req, row)) return res.status(403).json({ error: "Not owner" });

  const now = nowIso();

  db.prepare(`UPDATE listings SET status = 'deleted', deleted_at = ?, updated_at = ? WHERE id = ?`).run(now, now, id);
  return res.json({ ok: true });
});

// ---------- Action endpoints (ergonomic UI calls) ----------
function loadOwnedListing(req: express.Request, res: express.Response) {
  const id = req.params.id;
  const row = db.prepare<(ListingRow & any)>("SELECT * FROM listings WHERE id = ?").get(id);
  if (!row) {
    res.status(404).json({ error: "Not found" });
    return null;
  }
  if (!requireOwner(req, row)) {
    res.status(403).json({ error: "Not owner" });
    return null;
  }
  return row as ListingRow & any;
}

function setLifecycle(id: string, status: ListingStatus) {
  const now = nowIso();
  db.prepare(`UPDATE listings SET status=?, updated_at=? WHERE id=?`).run(status, now, id);
}

function setResolution(id: string, resolution: ListingResolution) {
  const now = nowIso();
  db.prepare(`UPDATE listings SET resolution=?, resolved_at=?, updated_at=? WHERE id=?`).run(resolution, now, now, id);
}

app.post("/api/listings/:id/pause", (req, res) => {
  runAutoExpirePass();
  const row = loadOwnedListing(req, res);
  if (!row) return;

  const status = String(row.status ?? "active") as ListingStatus;
  const resolution = String(row.resolution ?? "none") as ListingResolution;

  if (status === "deleted") return res.status(400).json({ error: "Listing is deleted" });
  if (status === "expired") return res.status(400).json({ error: "Listing is expired" });
  if (status === "paused") return res.json(mapListing(row)); // idempotent
  if (status === "draft") return res.status(400).json({ error: "Draft listings must be published first" });
  if (resolution !== "none") return res.status(400).json({ error: "Resolved listings cannot be paused" });

  setLifecycle(row.id, "paused");
  const updated = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(row.id);
  return res.json(mapListing(updated!));
});

app.post("/api/listings/:id/resume", (req, res) => {
  runAutoExpirePass();
  const row = loadOwnedListing(req, res);
  if (!row) return;

  const status = String(row.status ?? "active") as ListingStatus;
  const resolution = String(row.resolution ?? "none") as ListingResolution;

  if (status === "deleted") return res.status(400).json({ error: "Listing is deleted" });
  if (status === "expired") return res.status(400).json({ error: "Listing is expired" });
  if (resolution !== "none") return res.status(400).json({ error: "Resolved listings cannot be resumed" });

  // Resume from paused -> active
  if (status !== "paused") return res.status(400).json({ error: "Only paused listings can be resumed" });

  setLifecycle(row.id, "active");
  const updated = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(row.id);
  return res.json(mapListing(updated!));
});

app.post("/api/listings/:id/mark-sold", (req, res) => {
  runAutoExpirePass();
  const row = loadOwnedListing(req, res);
  if (!row) return;

  const status = String(row.status ?? "active") as ListingStatus;
  const resolution = String(row.resolution ?? "none") as ListingResolution;

  if (status === "deleted") return res.status(400).json({ error: "Listing is deleted" });
  if (status === "expired") return res.status(400).json({ error: "Listing is expired" });
  if (resolution !== "none") return res.status(400).json({ error: "Listing is already resolved" });

  setResolution(row.id, "sold");
  const updated = db.prepare<ListingRow & any>("SELECT * FROM listings WHERE id = ?").get(row.id);
  return res.json(mapListing(updated!));
});

// ---------- Images helpers ----------
function getImagesForListing(listingId: string): ImageAsset[] {
  const rows = db
    .prepare(
      `SELECT url, thumb_url, medium_url
       FROM listing_images
       WHERE listing_id = ?
       ORDER BY sort_order ASC`
    )
    .all(listingId) as { url: string; thumb_url: string | null; medium_url: string | null }[];

  return rows.map((r) => ({
    url: r.url,
    thumbUrl: r.thumb_url ?? r.url,
    mediumUrl: r.medium_url ?? r.url,
  }));
}

function mapListing(row: ListingRow & any) {
  const images = getImagesForListing(row.id);

  const status = String(row.status ?? "active") as ListingStatus;
  const resolution = String(row.resolution ?? "none") as ListingResolution;

  return {
    id: row.id,
    title: row.title,
    category: row.category,
    species: row.species,
    priceCents: row.price_cents,
    location: row.location,
    description: row.description,
    contact: row.contact ?? null,
    imageUrl: row.image_url ?? null,
    images,

    status,
    resolution,
    expiresAt: row.expires_at ?? null,
    resolvedAt: row.resolved_at ?? null,

    createdAt: row.created_at,
    updatedAt: row.updated_at ?? row.created_at,
  };
}

const PORT = process.env.PORT ? Number(process.env.PORT) : 3001;
app.listen(PORT, () => {
  console.log(`API running on http://localhost:${PORT}`);
});

@@@

@@@frontend\eslint.config.js
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import tseslint from 'typescript-eslint'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{ts,tsx}'],
    extends: [
      js.configs.recommended,
      tseslint.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
    },
  },
])

@@@

@@@frontend\index.html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fishclassifieds</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

@@@

@@@frontend\package.json
{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-router-dom": "^7.11.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.18",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "@vitejs/plugin-react": "^4.3.1",
    "autoprefixer": "^10.4.23",
    "postcss": "^8.5.6",
    "tailwindcss": "^4.1.18",
    "typescript": "^5.5.4",
    "vite": "^5.4.2"
  }
}

@@@

@@@frontend\postcss.config.js
export default {
  plugins: {
    "@tailwindcss/postcss": {},
    autoprefixer: {}
  }
};

@@@

@@@frontend\tailwind.config.js
/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{js,ts,jsx,tsx}"],
  theme: { extend: {} },
  plugins: []
};

@@@

@@@frontend\tsconfig.app.json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "types": ["vite/client"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,
    "jsx": "react-jsx",

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["src"]
}

@@@

@@@frontend\tsconfig.json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.app.json" },
    { "path": "./tsconfig.node.json" }
  ]
}

@@@

@@@frontend\tsconfig.node.json
{
  "compilerOptions": {
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",
    "target": "ES2023",
    "lib": ["ES2023"],
    "module": "ESNext",
    "types": ["node"],
    "skipLibCheck": true,

    /* Bundler mode */
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "verbatimModuleSyntax": true,
    "moduleDetection": "force",
    "noEmit": true,

    /* Linting */
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "erasableSyntaxOnly": true,
    "noFallthroughCasesInSwitch": true,
    "noUncheckedSideEffectImports": true
  },
  "include": ["vite.config.ts"]
}

@@@

@@@frontend\vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

// https://vite.dev/config/
export default defineConfig({
  plugins: [react()],
})

@@@

@@@frontend\src\api.ts
// frontend/src/api.ts
export type Category = "Fish" | "Shrimp" | "Snails" | "Plants" | "Equipment";
export type ListingStatus = "draft" | "pending" | "active" | "paused" | "expired" | "deleted";
export type ListingResolution = "none" | "sold";

export type ImageAsset = {
  url: string;
  thumbUrl?: string | null;
  mediumUrl?: string | null;
};

export type Listing = {
  id: string;
  title: string;
  category: Category;
  species: string;
  priceCents: number;
  location: string;
  description: string;
  contact: string | null;

  // legacy (may exist; backend also returns it)
  imageUrl: string | null;

  images: ImageAsset[];

  status: ListingStatus;
  resolution: ListingResolution;

  expiresAt: string | null;
  resolvedAt: string | null;

  createdAt: string;
  updatedAt: string;
};

export type SortMode = "newest" | "price_asc" | "price_desc";

const API_BASE =
  (import.meta as any).env?.VITE_API_URL?.toString().trim() ||
  "http://localhost:3001";

async function apiFetch<T>(path: string, init?: RequestInit): Promise<T> {
  const res = await fetch(`${API_BASE}${path}`, {
    ...init,
    headers: {
      ...(init?.headers || {}),
    },
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`API ${res.status}: ${text || res.statusText}`);
  }

  const ct = res.headers.get("content-type") || "";
  if (!ct.includes("application/json")) return undefined as unknown as T;
  return (await res.json()) as T;
}

// ----- URL helpers -----
export function resolveImageUrl(u: string | null | undefined) {
  if (!u) return null;
  const s = String(u);
  if (s.startsWith("http://") || s.startsWith("https://")) return s;
  // backend serves /uploads from same API base
  if (s.startsWith("/")) return `${API_BASE}${s}`;
  return s;
}

export function resolveAssets(images: Array<string | ImageAsset> | null | undefined): ImageAsset[] {
  const arr = images ?? [];
  return arr.map((x) => {
    if (typeof x === "string") return { url: x, thumbUrl: x, mediumUrl: x };
    return {
      url: x.url,
      thumbUrl: x.thumbUrl ?? x.url,
      mediumUrl: x.mediumUrl ?? x.url,
    };
  });
}

// ----- Owner token storage -----
const OWNER_TOKEN_KEY = "fish_owner_tokens_v1";

function loadOwnerMap(): Record<string, string> {
  try {
    const raw = localStorage.getItem(OWNER_TOKEN_KEY);
    if (!raw) return {};
    const obj = JSON.parse(raw);
    if (!obj || typeof obj !== "object") return {};
    const out: Record<string, string> = {};
    for (const [k, v] of Object.entries(obj)) {
      if (typeof k === "string" && typeof v === "string" && v.trim()) out[k] = v.trim();
    }
    return out;
  } catch {
    return {};
  }
}

function saveOwnerMap(map: Record<string, string>) {
  localStorage.setItem(OWNER_TOKEN_KEY, JSON.stringify(map));
}

export function setOwnerToken(listingId: string, token: string) {
  const map = loadOwnerMap();
  map[String(listingId)] = String(token);
  saveOwnerMap(map);
}

export function getOwnerToken(listingId: string) {
  const map = loadOwnerMap();
  return map[String(listingId)] ?? null;
}

export function removeOwnerToken(listingId: string) {
  const map = loadOwnerMap();
  delete map[String(listingId)];
  saveOwnerMap(map);
}

export function listOwnedIds(): string[] {
  const map = loadOwnerMap();
  return Object.keys(map);
}

// ----- Listings -----
export async function fetchListings(params?: {
  q?: string;
  category?: Category;
  species?: string;
  minPriceCents?: number;
  maxPriceCents?: number;
  sort?: SortMode;
  limit?: number;
  offset?: number;
}) {
  const qs = new URLSearchParams();
  if (params?.q) qs.set("q", params.q);
  if (params?.category) qs.set("category", params.category);
  if (params?.species) qs.set("species", params.species);

  if (params?.minPriceCents !== undefined) qs.set("minPriceCents", String(params.minPriceCents));
  if (params?.maxPriceCents !== undefined) qs.set("maxPriceCents", String(params.maxPriceCents));

  if (params?.sort) qs.set("sort", params.sort);
  if (params?.limit !== undefined) qs.set("limit", String(params.limit));
  if (params?.offset !== undefined) qs.set("offset", String(params.offset));

  const suffix = qs.toString() ? `?${qs.toString()}` : "";
  return apiFetch<{ items: Listing[]; total: number; limit: number; offset: number }>(`/api/listings${suffix}`);
}

export async function fetchListing(id: string) {
  return apiFetch<Listing>(`/api/listings/${encodeURIComponent(id)}`);
}

export async function createListing(input: {
  title: string;
  category: Category;
  species: string;
  priceCents: number;
  location: string;
  description: string;
  contact?: string | null;

  images?: Array<string | ImageAsset>;
  imageUrl?: string | null;

  // optional
  status?: "draft" | "active";
}) {
  const body = JSON.stringify(input);

  const res = await apiFetch<Listing & { ownerToken: string }>(`/api/listings`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body,
  });

  return res;
}

export async function updateListing(
  id: string,
  input: {
    title?: string;
    category?: Category;
    species?: string;
    priceCents?: number;
    location?: string;
    description?: string;
    contact?: string | null;

    images?: Array<string | ImageAsset>;
    imageUrl?: string | null;
  }
) {
  const token = getOwnerToken(id);
  if (!token) throw new Error("Missing owner token for this listing (not created on this device).");

  return apiFetch<Listing>(`/api/listings/${encodeURIComponent(id)}`, {
    method: "PATCH",
    headers: {
      "Content-Type": "application/json",
      "x-owner-token": token,
    },
    body: JSON.stringify(input),
  });
}

export async function deleteListing(id: string) {
  const token = getOwnerToken(id);
  if (!token) throw new Error("Missing owner token for this listing (not created on this device).");

  return apiFetch<{ ok: true }>(`/api/listings/${encodeURIComponent(id)}`, {
    method: "DELETE",
    headers: {
      "x-owner-token": token,
    },
  });
}

// ----- Action endpoints -----
async function postAction(id: string, action: "pause" | "resume" | "mark-sold") {
  const token = getOwnerToken(id);
  if (!token) throw new Error("Missing owner token for this listing (not created on this device).");

  return apiFetch<Listing>(`/api/listings/${encodeURIComponent(id)}/${action}`, {
    method: "POST",
    headers: {
      "x-owner-token": token,
    },
  });
}

export function pauseListing(id: string) {
  return postAction(id, "pause");
}

export function resumeListing(id: string) {
  return postAction(id, "resume");
}

export function markSold(id: string) {
  return postAction(id, "mark-sold");
}

// ----- Uploads -----
export async function uploadImage(file: File): Promise<ImageAsset> {
  const fd = new FormData();
  fd.append("image", file);

  const res = await fetch(`${API_BASE}/api/uploads`, {
    method: "POST",
    body: fd,
  });

  if (!res.ok) {
    const text = await res.text().catch(() => "");
    throw new Error(`Upload ${res.status}: ${text || res.statusText}`);
  }

  const data = (await res.json()) as { url: string; thumbUrl: string; mediumUrl: string };
  return data;
}

@@@

@@@frontend\src\App.tsx
import { Routes, Route } from "react-router-dom";
import HomePage from "./pages/HomePage";
import LoginPage from "./pages/LoginPage";
import SignUpPage from "./pages/SignUpPage";
import ListingPage from "./pages/ListingPage";
import PostListingPage from "./pages/PostListingPage";
import MyListingsPage from "./pages/MyListingsPage";
import EditListingPage from "./pages/EditListingPage";

export default function App() {
  return (
    <Routes>
      <Route path="/" element={<HomePage />} />
      <Route path="/listing/:id" element={<ListingPage />} />
      <Route path="/post" element={<PostListingPage />} />
      <Route path="/me" element={<MyListingsPage />} />
      <Route path="/edit/:id" element={<EditListingPage />} />
      <Route path="/login" element={<LoginPage />} />
      <Route path="/signup" element={<SignUpPage />} />
    </Routes>
  );
}

@@@

@@@frontend\src\index.css
@import "tailwindcss";

html,
body,
#root {
  height: 100%;
}

body {
  margin: 0;
  background: #f8fafc; /* slate-50 */
  color: #0f172a;      /* slate-900 */
}

@@@

@@@frontend\src\main.tsx
import { StrictMode } from "react";
import { createRoot } from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import "./index.css";
import App from "./App";

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </StrictMode>
);

@@@

@@@frontend\src\pages\EditListingPage.tsx
import { useEffect, useMemo, useState } from "react";
import { Link, useNavigate, useParams } from "react-router-dom";
import {
  deleteListing,
  fetchListing,
  getOwnerToken,
  removeOwnerToken,
  resolveAssets,
  resolveImageUrl,
  updateListing,
  uploadImage,
  pauseListing,
  resumeListing,
  markSold,
  type Category,
  type Listing,
  type ImageAsset,
} from "../api";

function dollarsToCents(v: string) {
  const n = Number(v);
  if (!Number.isFinite(n) || n < 0) return null;
  return Math.round(n * 100);
}

function centsToDollarsString(cents: number) {
  return (cents / 100).toFixed(2);
}

const CATEGORIES: Category[] = ["Fish", "Shrimp", "Snails", "Plants", "Equipment"];

type PendingImage = {
  id: string;
  file: File;
  uploaded?: ImageAsset;
  status: "ready" | "uploading" | "uploaded" | "error";
  error?: string;
};

function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function fmtStatus(l: Listing) {
  const parts: string[] = [];
  if (l.status === "draft") parts.push("Draft (hidden)");
  if (l.status === "pending") parts.push("Pending (public)");
  if (l.status === "active") parts.push("Active (public)");
  if (l.status === "paused") parts.push("Paused (hidden)");
  if (l.status === "expired") parts.push("Expired (hidden)");
  if (l.status === "deleted") parts.push("Deleted");

  if (l.resolution === "sold") parts.push("Marked sold");

  return parts.join(" â€¢ ");
}

function IconButton(props: {
  title: string;
  onClick?: () => void;
  disabled?: boolean;
  variant?: "default" | "danger" | "primary";
  children: React.ReactNode;
}) {
  const { title, onClick, disabled, variant = "default", children } = props;

  const base =
    "inline-flex items-center justify-center rounded-xl border px-3 py-2 text-sm font-semibold transition focus:outline-none focus-visible:ring-2";
  const cls =
    variant === "danger"
      ? "border-red-200 bg-white text-red-700 hover:bg-red-50 focus-visible:ring-red-300 disabled:opacity-60"
      : variant === "primary"
      ? "border-slate-900 bg-slate-900 text-white hover:bg-slate-800 focus-visible:ring-slate-400 disabled:opacity-60"
      : "border-slate-200 bg-white text-slate-900 hover:bg-slate-50 focus-visible:ring-slate-300 disabled:opacity-60";

  return (
    <button type="button" title={title} aria-label={title} onClick={onClick} disabled={disabled} className={`${base} ${cls}`}>
      {children}
    </button>
  );
}

function IconPause() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 5h3v14H7V5zm7 0h3v14h-3V5z" fill="currentColor" />
    </svg>
  );
}
function IconPlay() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8 5v14l11-7L8 5z" fill="currentColor" />
    </svg>
  );
}
function IconCheck() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M9.2 16.2 4.8 11.8l1.4-1.4 3 3 8.6-8.6 1.4 1.4-10 10z"
        fill="currentColor"
      />
    </svg>
  );
}
function IconTrash() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9z"
        fill="currentColor"
      />
    </svg>
  );
}

export default function EditListingPage() {
  const { id } = useParams();
  const nav = useNavigate();

  const [orig, setOrig] = useState<Listing | null>(null);

  const [title, setTitle] = useState("");
  const [category, setCategory] = useState<Category>("Fish");
  const [species, setSpecies] = useState("");
  const [priceDollars, setPriceDollars] = useState("");
  const [location, setLocation] = useState("");
  const [contact, setContact] = useState("");
  const [description, setDescription] = useState("");

  const [images, setImages] = useState<ImageAsset[]>([]);
  const [pending, setPending] = useState<PendingImage[]>([]);

  const [loading, setLoading] = useState(false);
  const [uploading, setUploading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const ownerToken = id ? getOwnerToken(id) : null;

  useEffect(() => {
    let cancelled = false;
    async function run() {
      if (!id) return;
      setErr(null);
      setLoading(true);
      try {
        const l = await fetchListing(id);
        if (cancelled) return;

        setOrig(l);
        setTitle(l.title);
        setCategory(l.category);
        setSpecies(l.species);
        setPriceDollars(centsToDollarsString(l.priceCents));
        setLocation(l.location);
        setContact(l.contact ?? "");
        setDescription(l.description);
        setImages((l.images ?? []).slice(0, 6));
        setPending([]);
      } catch (e: any) {
        if (!cancelled) setErr(e?.message ?? "Failed to load listing");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    run();
    return () => {
      cancelled = true;
    };
  }, [id]);

  const existingPreviews = useMemo(() => {
    const assets = resolveAssets(images ?? []);
    return assets.map((a) => a.thumbUrl || a.url).filter(Boolean);
  }, [images]);

  const pendingPreviews = useMemo(() => {
    return pending.map((p) => {
      const resolvedThumb = p.uploaded?.thumbUrl ? resolveImageUrl(p.uploaded.thumbUrl) : null;
      const resolvedUrl = p.uploaded?.url ? resolveImageUrl(p.uploaded.url) : null;

      return {
        id: p.id,
        status: p.status,
        error: p.error,
        src: resolvedThumb || resolvedUrl || URL.createObjectURL(p.file),
        uploaded: !!p.uploaded,
        local: !p.uploaded,
      };
    });
  }, [pending]);

  useEffect(() => {
    const locals = pendingPreviews.filter((p) => p.local).map((p) => p.src);
    return () => {
      for (const u of locals) URL.revokeObjectURL(u);
    };
  }, [pendingPreviews]);

  function moveExisting(idx: number, dir: -1 | 1) {
    setImages((prev) => {
      const j = idx + dir;
      if (j < 0 || j >= prev.length) return prev;
      const copy = [...prev];
      const tmp = copy[idx];
      copy[idx] = copy[j];
      copy[j] = tmp;
      return copy;
    });
  }

  function removeExisting(idx: number) {
    setImages((prev) => prev.filter((_, i) => i !== idx));
  }

  function onPickFiles(nextFiles: FileList | null) {
    setErr(null);
    if (!nextFiles) return;

    setPending((prev) => {
      const room = Math.max(0, 6 - (images.length + prev.length));
      const picked = Array.from(nextFiles).slice(0, room);
      if (!picked.length) return prev;

      return [
        ...prev,
        ...picked.map((f) => ({
          id: uid(),
          file: f,
          status: "ready" as const,
        })),
      ];
    });
  }

  function removePending(pid: string) {
    setPending((prev) => prev.filter((x) => x.id !== pid));
  }

  function movePending(pid: string, dir: -1 | 1) {
    setPending((prev) => {
      const i = prev.findIndex((x) => x.id === pid);
      if (i < 0) return prev;
      const j = i + dir;
      if (j < 0 || j >= prev.length) return prev;
      const copy = [...prev];
      const tmp = copy[i];
      copy[i] = copy[j];
      copy[j] = tmp;
      return copy;
    });
  }

  async function uploadOne(p: PendingImage) {
    setPending((prev) => prev.map((x) => (x.id === p.id ? { ...x, status: "uploading", error: undefined } : x)));
    try {
      const asset = await uploadImage(p.file);
      setPending((prev) => prev.map((x) => (x.id === p.id ? { ...x, status: "uploaded", uploaded: asset } : x)));
      return asset;
    } catch (e: any) {
      const msg = e?.message ?? "Upload failed";
      setPending((prev) => prev.map((x) => (x.id === p.id ? { ...x, status: "error", error: msg } : x)));
      throw new Error(msg);
    }
  }

  async function uploadAllPending() {
    if (!pending.length) return;
    setUploading(true);
    try {
      for (const p of pending) {
        if (p.status === "uploaded" && p.uploaded) continue;
        await uploadOne(p).catch(() => {});
      }
    } finally {
      setUploading(false);
    }
  }

  async function refresh() {
    if (!id) return;
    const l = await fetchListing(id);
    setOrig(l);
    setTitle(l.title);
    setCategory(l.category);
    setSpecies(l.species);
    setPriceDollars(centsToDollarsString(l.priceCents));
    setLocation(l.location);
    setContact(l.contact ?? "");
    setDescription(l.description);
    setImages((l.images ?? []).slice(0, 6));
    setPending([]);
  }

  async function onSave(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    if (!id) return;

    if (!ownerToken) {
      setErr("Missing owner token for this listing (it wasn't created on this device).");
      return;
    }

    const priceCents = dollarsToCents(priceDollars);
    if (priceCents === null) {
      setErr("Please enter a valid non-negative price.");
      return;
    }

    setLoading(true);
    try {
      if (pending.some((p) => p.status !== "uploaded")) {
        await uploadAllPending();
      }

      const newlyUploaded = pending
        .filter((p) => p.status === "uploaded" && p.uploaded)
        .map((p) => p.uploaded!)
        .slice(0, 6);

      const merged = [...images, ...newlyUploaded].slice(0, 6);

      const updated = await updateListing(id, {
        title: title.trim(),
        category,
        species: species.trim(),
        priceCents,
        location: location.trim(),
        description: description.trim(),
        contact: contact.trim() ? contact.trim() : null,
        images: merged,
      });

      setOrig(updated);
      setImages((updated.images ?? []).slice(0, 6));
      setPending([]);
      nav(`/listing/${id}`);
    } catch (e: any) {
      setErr(e?.message ?? "Save failed");
    } finally {
      setLoading(false);
    }
  }

  async function onDelete() {
    if (!id) return;
    setErr(null);

    if (!ownerToken) {
      setErr("Missing owner token for this listing (it wasn't created on this device).");
      return;
    }

    const ok = window.confirm("Delete this listing? This cannot be undone.");
    if (!ok) return;

    setLoading(true);
    try {
      await deleteListing(id);
      removeOwnerToken(id);
      nav("/me");
    } catch (e: any) {
      setErr(e?.message ?? "Delete failed");
    } finally {
      setLoading(false);
    }
  }

  async function doTogglePauseResume() {
    if (!id || !orig) return;
    setErr(null);
    setLoading(true);
    try {
      if (orig.status === "paused") {
        await resumeListing(id);
      } else {
        await pauseListing(id);
      }
      await refresh();
    } catch (e: any) {
      setErr(e?.message ?? "Failed to update listing status");
    } finally {
      setLoading(false);
    }
  }

  async function doSold() {
    if (!id) return;
    setErr(null);
    const ok = window.confirm("Mark this listing as SOLD? It will be hidden from Browse.");
    if (!ok) return;

    setLoading(true);
    try {
      await markSold(id);
      await refresh();
    } catch (e: any) {
      setErr(e?.message ?? "Failed to mark sold");
    } finally {
      setLoading(false);
    }
  }

  const canSave = !loading && !uploading;

  const canTogglePause =
    !!ownerToken &&
    !!orig &&
    orig.status !== "draft" &&
    orig.status !== "expired" &&
    orig.status !== "deleted" &&
    orig.resolution === "none";

  const toggleLabel = orig?.status === "paused" ? "Resume listing" : "Pause listing";

  const canResolve =
    !!ownerToken &&
    !!orig &&
    orig.status !== "expired" &&
    orig.status !== "deleted" &&
    orig.resolution === "none";

  return (
    <div className="min-h-full">
      <header className="border-b border-slate-200 bg-white">
        <div className="mx-auto flex max-w-3xl items-center justify-between px-4 py-3">
          <Link to="/" className="font-extrabold tracking-tight text-slate-900">
            Fishclassifieds
          </Link>
          <div className="flex items-center gap-3">
            <Link to="/me" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              My listings
            </Link>
            <Link to="/" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              Browse
            </Link>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-3xl px-4 py-6">
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-extrabold text-slate-900">Edit listing</h1>
          {id && (
            <Link to={`/listing/${id}`} className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              View
            </Link>
          )}
        </div>

        {!ownerToken && (
          <div className="mt-4 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-900">
            You can view this listing, but you can't edit/delete it from this device (missing owner token).
          </div>
        )}

        {err && <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">{err}</div>}

        {loading && !orig && <div className="mt-4 text-sm text-slate-600">Loading...</div>}

        {orig && (
          <form onSubmit={onSave} className="mt-6 space-y-4 rounded-2xl border border-slate-200 bg-white p-5">
            {/* Lifecycle + actions */}
            <div className="rounded-2xl border border-slate-200 p-4">
              <div className="text-sm font-bold text-slate-900">Listing state</div>
              <div className="mt-1 text-xs text-slate-600">{fmtStatus(orig)}</div>

              <div className="mt-3 flex flex-wrap items-center gap-2">
                <IconButton
                title={toggleLabel}
                onClick={doTogglePauseResume}
                disabled={!canTogglePause || loading}
                variant="default"
                >
                {orig.status === "paused" ? (
                    <>
                    <IconPlay />
                    <span className="ml-2">Resume Ad</span>
                    </>
                ) : (
                    <>
                    <IconPause />
                    <span className="ml-2">Pause Ad</span>
                    </>
                )}
                </IconButton>

                <IconButton title="Mark as sold" onClick={doSold} disabled={!canResolve || loading} variant="primary">
                  <IconCheck />
                  <span className="ml-2">Mark as Sold</span>
                </IconButton>

                <IconButton title="Delete listing" onClick={onDelete} disabled={loading || uploading || !ownerToken} variant="danger">
                  <IconTrash />
                  <span className="ml-2">Delete</span>
                </IconButton>
              </div>

              <div className="mt-3 text-xs text-slate-600">
                {orig.expiresAt ? (
                  <>
                    Expires{" "}
                    {new Date(orig.expiresAt).toLocaleString(undefined, {
                      year: "numeric",
                      month: "short",
                      day: "2-digit",
                      hour: "2-digit",
                      minute: "2-digit",
                    })}
                    . Expiry is automatic.
                  </>
                ) : (
                  <>Expiry is automatic.</>
                )}
              </div>
            </div>

            {/* Images */}
            <div className="rounded-2xl border border-slate-200 p-4">
              <div className="flex items-center justify-between gap-3">
                <div>
                  <div className="text-sm font-bold text-slate-900">Photos</div>
                  <div className="text-xs text-slate-600">Up to 6 total (existing + new)</div>
                </div>

                <div className="flex items-center gap-2">
                  <label className="cursor-pointer rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                    Add photos
                    <input
                      type="file"
                      multiple
                      accept="image/jpeg,image/png,image/webp"
                      className="hidden"
                      onChange={(e) => onPickFiles(e.target.files)}
                    />
                  </label>

                  <button
                    type="button"
                    onClick={uploadAllPending}
                    disabled={!pending.length || uploading}
                    className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60"
                  >
                    {uploading ? "Uploading..." : "Upload new"}
                  </button>
                </div>
              </div>

              {/* Existing */}
              <div className="mt-4">
                <div className="text-xs font-semibold text-slate-700">Existing</div>
                <div className="mt-2 grid gap-3 sm:grid-cols-3">
                  {existingPreviews.length ? (
                    existingPreviews.map((src, idx) => (
                      <div key={src + idx} className="overflow-hidden rounded-2xl border border-slate-200 bg-white">
                        <div className="relative h-28 w-full bg-slate-100">
                          <img src={src} alt={`existing-${idx}`} className="h-full w-full object-cover" />

                          <div className="absolute left-2 top-2 flex gap-1">
                            <button
                              type="button"
                              onClick={() => moveExisting(idx, -1)}
                              disabled={idx === 0}
                              className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                            >
                              â†
                            </button>
                            <button
                              type="button"
                              onClick={() => moveExisting(idx, 1)}
                              disabled={idx === existingPreviews.length - 1}
                              className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                            >
                              â†’
                            </button>
                          </div>

                          <button
                            type="button"
                            onClick={() => removeExisting(idx)}
                            className="absolute right-2 top-2 rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 hover:bg-white"
                            aria-label="Remove image"
                            title="Remove"
                          >
                            Ã—
                          </button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="col-span-full flex h-28 items-center justify-center rounded-2xl bg-slate-100 text-sm font-semibold text-slate-500">
                      No existing images
                    </div>
                  )}
                </div>
              </div>

              {/* Pending */}
              <div className="mt-4">
                <div className="text-xs font-semibold text-slate-700">New</div>
                <div className="mt-2 grid gap-3 sm:grid-cols-3">
                  {pendingPreviews.length ? (
                    pendingPreviews.map((p, idx) => (
                      <div key={p.id} className="overflow-hidden rounded-2xl border border-slate-200 bg-white">
                        <div className="relative h-28 w-full bg-slate-100">
                          <img src={p.src} alt={`pending-${idx}`} className="h-full w-full object-cover" />

                          <div className="absolute left-2 top-2 flex gap-1">
                            <button
                              type="button"
                              onClick={() => movePending(p.id, -1)}
                              disabled={idx === 0}
                              className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                            >
                              â†
                            </button>
                            <button
                              type="button"
                              onClick={() => movePending(p.id, 1)}
                              disabled={idx === pendingPreviews.length - 1}
                              className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                            >
                              â†’
                            </button>
                          </div>

                          <button
                            type="button"
                            onClick={() => removePending(p.id)}
                            className="absolute right-2 top-2 rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 hover:bg-white"
                            aria-label="Remove pending image"
                            title="Remove"
                          >
                            Ã—
                          </button>

                          <div className="absolute bottom-2 left-2 rounded-lg bg-white/90 px-2 py-1 text-[11px] font-semibold text-slate-700">
                            {p.status === "uploading"
                              ? "Uploading..."
                              : p.status === "uploaded"
                              ? "Uploaded"
                              : p.status === "error"
                              ? "Error"
                              : "Ready"}
                          </div>
                        </div>

                        {p.status === "error" && p.error && (
                          <div className="border-t border-red-100 bg-red-50 px-3 py-2 text-xs font-semibold text-red-700">
                            {p.error}
                          </div>
                        )}
                      </div>
                    ))
                  ) : (
                    <div className="col-span-full flex h-28 items-center justify-center rounded-2xl bg-slate-100 text-sm font-semibold text-slate-500">
                      No new images
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Fields */}
            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Title</div>
              <input
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                required
                minLength={3}
                maxLength={80}
                disabled={!ownerToken}
              />
            </label>

            <div className="grid gap-3 sm:grid-cols-2">
              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Category</div>
                <select
                  value={category}
                  onChange={(e) => setCategory(e.target.value as Category)}
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  disabled={!ownerToken}
                >
                  {CATEGORIES.map((c) => (
                    <option key={c} value={c}>
                      {c}
                    </option>
                  ))}
                </select>
              </label>

              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Species</div>
                <input
                  value={species}
                  onChange={(e) => setSpecies(e.target.value)}
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  required
                  minLength={2}
                  maxLength={60}
                  disabled={!ownerToken}
                />
              </label>
            </div>

            <div className="grid gap-3 sm:grid-cols-2">
              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Price ($)</div>
                <input
                  value={priceDollars}
                  onChange={(e) => setPriceDollars(e.target.value)}
                  inputMode="decimal"
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  required
                  disabled={!ownerToken}
                />
              </label>

              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Location</div>
                <input
                  value={location}
                  onChange={(e) => setLocation(e.target.value)}
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  required
                  minLength={2}
                  maxLength={80}
                  disabled={!ownerToken}
                />
              </label>
            </div>

            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Contact (optional)</div>
              <input
                value={contact}
                onChange={(e) => setContact(e.target.value)}
                placeholder="e.g. phone, email, or 'DM on FB: ...'"
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                maxLength={200}
                disabled={!ownerToken}
              />
            </label>

            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Description</div>
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="min-h-[140px] w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                required
                minLength={1}
                maxLength={1000}
                disabled={!ownerToken}
              />
            </label>

            <div className="flex gap-2">
              <button
                type="submit"
                disabled={!canSave || !ownerToken}
                className="flex-1 rounded-2xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60"
              >
                {loading ? "Saving..." : uploading ? "Uploading..." : "Save changes"}
              </button>
            </div>
          </form>
        )}
      </main>
    </div>
  );
}

@@@

@@@frontend\src\pages\HomePage.tsx
import { useEffect, useMemo, useState } from "react";
import { Link, useSearchParams } from "react-router-dom";
import { fetchListings, resolveAssets, type Category, type Listing } from "../api";

type SortMode = "newest" | "price_asc" | "price_desc";
type PageSize = 12 | 24 | 48 | 96;

function centsToDollars(cents: number) {
  return (cents / 100).toLocaleString(undefined, { style: "currency", currency: "AUD" });
}

function relativeTime(iso: string) {
  const d = new Date(iso).getTime();
  const now = Date.now();
  const s = Math.max(0, Math.floor((now - d) / 1000));
  if (s < 60) return `${s}s ago`;
  const m = Math.floor(s / 60);
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 48) return `${h}h ago`;
  const days = Math.floor(h / 24);
  return `${days}d ago`;
}

const CATEGORIES: ("" | Category)[] = ["", "Fish", "Shrimp", "Snails", "Plants", "Equipment"];
const PAGE_SIZES: PageSize[] = [12, 24, 48, 96];

function clampInt(v: string | null, fallback: number, min: number, max: number) {
  const n = Number(v);
  if (!Number.isFinite(n)) return fallback;
  return Math.max(min, Math.min(max, Math.floor(n)));
}

function buildPageButtons(current: number, totalPages: number) {
  if (totalPages <= 7) return Array.from({ length: totalPages }, (_, i) => i + 1);

  const out: (number | "â€¦")[] = [];
  const show = new Set<number>();

  show.add(1);
  show.add(totalPages);

  for (let p = current - 2; p <= current + 2; p++) {
    if (p >= 1 && p <= totalPages) show.add(p);
  }

  show.add(2);
  show.add(3);
  show.add(totalPages - 1);
  show.add(totalPages - 2);

  const pages = Array.from(show).sort((a, b) => a - b);

  let prev = 0;
  for (const p of pages) {
    if (prev && p - prev > 1) out.push("â€¦");
    out.push(p);
    prev = p;
  }
  return out;
}

function PaginationBar(props: {
  page: number;
  totalPages: number;
  loading: boolean;
  canPrev: boolean;
  canNext: boolean;
  pageButtons: (number | "â€¦")[];
  onPrev: () => void;
  onNext: () => void;
  onGoPage: (p: number) => void;
}) {
  const { page, totalPages, loading, canPrev, canNext, pageButtons, onPrev, onNext, onGoPage } = props;
  if (totalPages <= 1) return null;

  return (
    <div className="mt-4 flex flex-wrap items-center justify-center gap-2">
      <button
        type="button"
        onClick={onPrev}
        disabled={!canPrev || loading}
        className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50 disabled:opacity-60"
      >
        Prev
      </button>

      {pageButtons.map((p, i) =>
        p === "â€¦" ? (
          <div key={`dots-${i}`} className="px-2 text-sm font-semibold text-slate-500">
            â€¦
          </div>
        ) : (
          <button
            key={p}
            type="button"
            onClick={() => onGoPage(p)}
            disabled={loading}
            className={[
              "rounded-xl border px-3 py-2 text-sm font-semibold",
              p === page ? "border-slate-900 bg-slate-900 text-white" : "border-slate-200 bg-white text-slate-900 hover:bg-slate-50",
              loading ? "opacity-60" : "",
            ].join(" ")}
            aria-current={p === page ? "page" : undefined}
          >
            {p}
          </button>
        )
      )}

      <button
        type="button"
        onClick={onNext}
        disabled={!canNext || loading}
        className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50 disabled:opacity-60"
      >
        Next
      </button>
    </div>
  );
}

function StatusPill({ l }: { l: Listing }) {
  if (l.status !== "pending") return null;

  return (
    <div className="absolute left-3 top-3 rounded-full bg-black/55 px-2 py-1 text-[11px] font-bold text-white backdrop-blur">
      Pending
    </div>
  );
}

export default function HomePage() {
  const [sp, setSp] = useSearchParams();

  const q = sp.get("q") ?? "";
  const category = (sp.get("category") ?? "") as "" | Category;
  const species = sp.get("species") ?? "";
  const minDollars = sp.get("min") ?? "";
  const maxDollars = sp.get("max") ?? "";
  const sort = (sp.get("sort") ?? "newest") as SortMode;

  const page = clampInt(sp.get("page"), 1, 1, 999999);
  const per = clampInt(sp.get("per"), 24, 12, 200) as PageSize;

  const [items, setItems] = useState<Listing[]>([]);
  const [total, setTotal] = useState(0);

  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const minPriceCents = useMemo(() => {
    const s = String(minDollars ?? "").trim();
    if (!s) return undefined;
    const n = Number(s);
    return Number.isFinite(n) && n >= 0 ? Math.round(n * 100) : undefined;
  }, [minDollars]);

  const maxPriceCents = useMemo(() => {
    const s = String(maxDollars ?? "").trim();
    if (!s) return undefined;
    const n = Number(s);
    return Number.isFinite(n) && n >= 0 ? Math.round(n * 100) : undefined;
  }, [maxDollars]);

  const offset = (page - 1) * per;
  const totalPages = Math.max(1, Math.ceil(total / per));
  const pageButtons = buildPageButtons(page, totalPages);

  const speciesPresets = [
    "",
    "guppy",
    "betta",
    "goldfish",
    "angelfish",
    "discus",
    "neon tetra",
    "corydoras",
    "shrimp",
    "snails",
    "plants",
    "equipment",
  ];

  useEffect(() => {
    let cancelled = false;

    async function run() {
      setLoading(true);
      setErr(null);

      try {
        const data = await fetchListings({
          q: q || undefined,
          category: category || undefined,
          species: species || undefined,
          minPriceCents,
          maxPriceCents,
          sort,
          limit: per,
          offset,
        });

        if (cancelled) return;

        setItems(data.items);
        setTotal(data.total);

        const tp = Math.max(1, Math.ceil(data.total / per));
        if (page > tp) {
          const nextSp = new URLSearchParams(sp);
          nextSp.set("page", String(tp));
          setSp(nextSp, { replace: true });
        }
      } catch (e: any) {
        if (!cancelled) setErr(e?.message ?? "Failed to load listings");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }

    run();
    return () => {
      cancelled = true;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [q, category, species, minPriceCents, maxPriceCents, sort, per, page]);

  function setParam(key: string, value: string) {
    const next = new URLSearchParams(sp);

    const resetsPage =
      key === "q" ||
      key === "category" ||
      key === "species" ||
      key === "min" ||
      key === "max" ||
      key === "sort" ||
      key === "per";

    if (resetsPage) next.set("page", "1");

    if (!value) next.delete(key);
    else next.set(key, value);

    setSp(next, { replace: true });
  }

  function clearFilters() {
    setSp(new URLSearchParams(), { replace: true });
  }

  function goPage(p: number) {
    const next = new URLSearchParams(sp);
    next.set("page", String(Math.max(1, Math.min(totalPages, p))));
    setSp(next, { replace: true });
  }

  const showingFrom = total === 0 ? 0 : (page - 1) * per + 1;
  const showingTo = Math.min(total, (page - 1) * per + items.length);

  const canPrev = page > 1;
  const canNext = page < totalPages;

  return (
    <div className="min-h-full">
      <header className="sticky top-0 z-10 border-b border-slate-200 bg-white/90 backdrop-blur">
        <div className="mx-auto flex max-w-6xl items-center gap-3 px-4 py-3">
          <Link to="/" className="font-extrabold tracking-tight text-slate-900">
            Fishclassifieds
          </Link>

          <div className="flex-1" />

          <Link to="/post" className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
            Post a listing
          </Link>

          <Link to="/me" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
            My listings
          </Link>

          <div className="flex items-center gap-2">
            <Link to="/login" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              Login
            </Link>
            <span className="text-slate-300">/</span>
            <Link to="/signup" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              Sign up
            </Link>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-6xl px-4 py-6">
        <div className="grid gap-6 md:grid-cols-[280px_1fr]">
          <aside className="rounded-2xl border border-slate-200 bg-white p-4">
            <div className="flex items-center justify-between">
              <div className="text-sm font-bold text-slate-900">Filters</div>
              <button type="button" onClick={clearFilters} className="text-xs font-semibold text-slate-600 hover:text-slate-900">
                Clear
              </button>
            </div>

            <div className="mt-4 space-y-3">
              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Search</div>
                <input
                  value={q}
                  onChange={(e) => setParam("q", e.target.value)}
                  placeholder="e.g. guppy, Brisbane, breeder..."
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                />
              </label>

              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Category</div>
                <select
                  value={category}
                  onChange={(e) => setParam("category", e.target.value)}
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                >
                  {CATEGORIES.map((c) => (
                    <option key={c || "Any"} value={c}>
                      {c ? c : "Any"}
                    </option>
                  ))}
                </select>
              </label>

              <label className="block">
                <div className="mb-1 text-xs font-semibold text-slate-700">Species</div>
                <select
                  value={species}
                  onChange={(e) => setParam("species", e.target.value)}
                  className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                >
                  {speciesPresets.map((s) => (
                    <option key={s} value={s}>
                      {s ? s : "Any"}
                    </option>
                  ))}
                </select>
              </label>

              <div className="grid grid-cols-2 gap-3">
                <label className="block">
                  <div className="mb-1 text-xs font-semibold text-slate-700">Min ($)</div>
                  <input
                    value={minDollars}
                    onChange={(e) => setParam("min", e.target.value)}
                    inputMode="decimal"
                    placeholder="0"
                    className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  />
                </label>

                <label className="block">
                  <div className="mb-1 text-xs font-semibold text-slate-700">Max ($)</div>
                  <input
                    value={maxDollars}
                    onChange={(e) => setParam("max", e.target.value)}
                    inputMode="decimal"
                    placeholder="200"
                    className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                  />
                </label>
              </div>

              <div className="mt-4 rounded-xl bg-slate-50 p-3 text-xs text-slate-700">
                Tip: category narrows broad items; search finds details like â€œcherryâ€, â€œpairâ€, â€œbreederâ€.
              </div>
            </div>
          </aside>

          <section>
            <div className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
              <div>
                <h1 className="text-xl font-extrabold text-slate-900">Browse listings</h1>
                <div className="mt-1 text-sm text-slate-600">
                  {loading ? "Loading..." : total === 0 ? "0 results" : `Showing ${showingFrom}â€“${showingTo} of ${total}`}
                </div>
              </div>

              <div className="flex items-center gap-2">
                <label className="flex items-center gap-2">
                  <span className="text-xs font-semibold text-slate-700">Sort</span>
                  <select
                    value={sort}
                    onChange={(e) => setParam("sort", e.target.value)}
                    className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                  >
                    <option value="newest">Newest</option>
                    <option value="price_asc">Price: Low â†’ High</option>
                    <option value="price_desc">Price: High â†’ Low</option>
                  </select>
                </label>

                <label className="flex items-center gap-2">
                  <span className="text-xs font-semibold text-slate-700">Per page</span>
                  <select
                    value={String(per)}
                    onChange={(e) => setParam("per", e.target.value)}
                    className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400"
                  >
                    {PAGE_SIZES.map((n) => (
                      <option key={n} value={String(n)}>
                        {n}
                      </option>
                    ))}
                  </select>
                </label>
              </div>
            </div>

            <PaginationBar
              page={Math.min(page, totalPages)}
              totalPages={totalPages}
              loading={loading}
              canPrev={canPrev}
              canNext={canNext}
              pageButtons={pageButtons}
              onPrev={() => goPage(page - 1)}
              onNext={() => goPage(page + 1)}
              onGoPage={goPage}
            />

            {err && (
              <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">{err}</div>
            )}

            {!loading && !err && total === 0 && (
              <div className="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
                <div className="text-sm font-semibold text-slate-900">No results</div>
                <div className="mt-1 text-sm text-slate-600">Try clearing filters, or posting the first listing.</div>
              </div>
            )}

            <div className="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
              {items.map((l) => {
                const assets = resolveAssets(l.images ?? []);
                const hero = assets[0]?.thumbUrl ?? assets[0]?.url ?? null;

                return (
                  <Link
                    key={l.id}
                    to={`/listing/${l.id}`}
                    className="group overflow-hidden rounded-2xl border border-slate-200 bg-white hover:border-slate-300"
                  >
                    <div className="relative aspect-[4/3] w-full bg-slate-100">
                      <StatusPill l={l} />
                      {hero ? (
                        <img
                          src={hero}
                          alt={l.title}
                          className="h-full w-full object-cover transition-transform group-hover:scale-[1.02]"
                          loading="lazy"
                          decoding="async"
                        />
                      ) : (
                        <div className="flex h-full w-full items-center justify-center text-xs font-semibold text-slate-500">
                          No image
                        </div>
                      )}
                    </div>

                    <div className="p-4">
                      <div className="flex items-start justify-between gap-3">
                        <div className="min-w-0">
                          <div className="truncate text-sm font-extrabold text-slate-900">{l.title}</div>
                          <div className="mt-1 truncate text-xs font-semibold text-slate-600">
                            {l.category} â€¢ {l.species} â€¢ {l.location}
                          </div>
                        </div>
                        <div className="shrink-0 rounded-xl bg-slate-900 px-3 py-1 text-xs font-bold text-white">
                          {centsToDollars(l.priceCents)}
                        </div>
                      </div>

                      <div className="mt-3 line-clamp-2 text-xs text-slate-700">{l.description}</div>
                      <div className="mt-3 text-[11px] font-semibold text-slate-500">{relativeTime(l.createdAt)}</div>
                    </div>
                  </Link>
                );
              })}
            </div>

            <PaginationBar
              page={Math.min(page, totalPages)}
              totalPages={totalPages}
              loading={loading}
              canPrev={canPrev}
              canNext={canNext}
              pageButtons={pageButtons}
              onPrev={() => goPage(page - 1)}
              onNext={() => goPage(page + 1)}
              onGoPage={goPage}
            />
          </section>
        </div>
      </main>
    </div>
  );
}

@@@

@@@frontend\src\pages\ListingPage.tsx
// frontend/src/pages/ListingPage.tsx
import { useEffect, useMemo, useState } from "react";
import { Link, useParams } from "react-router-dom";
import { fetchListing, resolveAssets, type Listing } from "../api";

function centsToDollars(cents: number) {
  return (cents / 100).toLocaleString(undefined, { style: "currency", currency: "AUD" });
}

export default function ListingPage() {
  const { id } = useParams();
  const [item, setItem] = useState<Listing | null>(null);
  const [active, setActive] = useState(0);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  // Lightbox
  const [lightboxOpen, setLightboxOpen] = useState(false);

  useEffect(() => {
    let cancelled = false;
    async function run() {
      if (!id) return;
      setLoading(true);
      setErr(null);
      try {
        const data = await fetchListing(id);
        if (!cancelled) {
          setItem(data);
          setActive(0);
          setLightboxOpen(false);
        }
      } catch (e: any) {
        if (!cancelled) setErr(e?.message ?? "Failed to load listing");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    run();
    return () => {
      cancelled = true;
    };
  }, [id]);

  const assets = useMemo(() => {
    if (!item) return [];
    return resolveAssets(item.images ?? []);
  }, [item]);

  const hasMultiple = assets.length > 1;

  const hero =
    assets[active]?.mediumUrl ??
    assets[active]?.url ??
    assets[0]?.mediumUrl ??
    assets[0]?.url ??
    null;

  // Full-res for lightbox
  const fullRes =
    assets[active]?.url ??
    assets[0]?.url ??
    null;

  function prevImage() {
    setActive((i) => (i <= 0 ? assets.length - 1 : i - 1));
  }

  function nextImage() {
    setActive((i) => (i >= assets.length - 1 ? 0 : i + 1));
  }

  function openLightbox() {
    if (!assets.length) return;
    setLightboxOpen(true);
  }

  function closeLightbox() {
    setLightboxOpen(false);
  }

  // Keyboard controls while lightbox is open
  useEffect(() => {
    if (!lightboxOpen) return;

    function onKeyDown(e: KeyboardEvent) {
      if (e.key === "Escape") {
        e.preventDefault();
        closeLightbox();
        return;
      }
      if (!hasMultiple) return;

      if (e.key === "ArrowLeft") {
        e.preventDefault();
        prevImage();
        return;
      }
      if (e.key === "ArrowRight") {
        e.preventDefault();
        nextImage();
        return;
      }
    }

    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [lightboxOpen, hasMultiple, assets.length]);

  // Prevent background scroll while lightbox open
  useEffect(() => {
    if (!lightboxOpen) return;
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return () => {
      document.body.style.overflow = prev;
    };
  }, [lightboxOpen]);

  return (
    <div className="min-h-full">
      <header className="border-b border-slate-200 bg-white">
        <div className="mx-auto flex max-w-5xl items-center justify-between px-4 py-3">
          <Link to="/" className="font-extrabold tracking-tight text-slate-900">
            Fishclassifieds
          </Link>
          <div className="flex items-center gap-3">
            <Link to="/me" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              My listings
            </Link>
            <Link
              to="/post"
              className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800"
            >
              Post a listing
            </Link>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-5xl px-4 py-6">
        <Link to="/" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
          â† Back to listings
        </Link>

        {loading && <div className="mt-4 text-sm text-slate-600">Loadingâ€¦</div>}

        {err && (
          <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">
            {err}
          </div>
        )}

        {item && (
          <div className="mt-4 grid gap-6 lg:grid-cols-[1fr_360px]">
            <div className="overflow-hidden rounded-2xl border border-slate-200 bg-white">
              <div className="bg-slate-100">
                {/* Image box */}
                <div className="relative aspect-[4/3] w-full bg-slate-100">
                  {hero ? (
                    <img src={hero} alt={item.title} className="h-full w-full object-cover" />
                  ) : (
                    <div className="flex h-full w-full items-center justify-center text-xs font-semibold text-slate-500">
                      No image
                    </div>
                  )}

                  {/* Maximize button (top-right) */}
                  {hero && (
                    <button
                      type="button"
                      onClick={openLightbox}
                      aria-label="Maximize image"
                      className="
                        absolute right-3 top-3
                        rounded-full border border-white/30
                        bg-slate-900/15 backdrop-blur
                        px-3 py-2
                        text-white
                        shadow-sm
                        transition
                        hover:bg-slate-900/35 hover:border-white/50
                        focus:outline-none
                        focus-visible:ring-2 focus-visible:ring-white/60
                      "
                      title="View full size"
                    >
                      â¤¢
                    </button>
                  )}

                  {/* Navigation arrows (only if >1 image) */}
                  {hasMultiple && (
                    <>
                      <button
                        type="button"
                        onClick={prevImage}
                        aria-label="Previous image"
                        className="
                          absolute left-3 top-1/2 -translate-y-1/2
                          rounded-full border border-white/30
                          bg-slate-900/15 backdrop-blur
                          px-3 py-2
                          text-white
                          shadow-sm
                          transition
                          hover:bg-slate-900/35 hover:border-white/50
                          focus:outline-none
                          focus-visible:ring-2 focus-visible:ring-white/60
                        "
                      >
                        â€¹
                      </button>

                      <button
                        type="button"
                        onClick={nextImage}
                        aria-label="Next image"
                        className="
                          absolute right-3 top-1/2 -translate-y-1/2
                          rounded-full border border-white/30
                          bg-slate-900/15 backdrop-blur
                          px-3 py-2
                          text-white
                          shadow-sm
                          transition
                          hover:bg-slate-900/35 hover:border-white/50
                          focus:outline-none
                          focus-visible:ring-2 focus-visible:ring-white/60
                        "
                      >
                        â€º
                      </button>
                    </>
                  )}
                </div>

                {/* Thumbnails */}
                {assets.length > 0 && (
                  <div className="flex gap-2 overflow-x-auto p-3">
                    {assets.map((a, i) => (
                      <button
                        key={a.url + i}
                        type="button"
                        onClick={() => setActive(i)}
                        className={[
                          "h-16 w-20 shrink-0 overflow-hidden rounded-xl border bg-white",
                          i === active ? "border-slate-900" : "border-slate-200",
                        ].join(" ")}
                        title={`Image ${i + 1}`}
                        aria-current={i === active ? "true" : undefined}
                      >
                        <img
                          src={a.thumbUrl || a.url}
                          alt={`thumb-${i}`}
                          className="h-full w-full object-cover"
                          loading="lazy"
                          decoding="async"
                        />
                      </button>
                    ))}
                  </div>
                )}
              </div>

              <div className="p-5">
                <h1 className="text-2xl font-extrabold text-slate-900">{item.title}</h1>
                <div className="mt-2 text-sm font-semibold text-slate-600">
                  {item.category} â€¢ {item.species} â€¢ {item.location}
                </div>

                <div className="mt-4 whitespace-pre-wrap text-sm text-slate-800">{item.description}</div>

                <div className="mt-5 text-xs font-semibold text-slate-500">
                  Posted{" "}
                  {new Date(item.createdAt).toLocaleString(undefined, {
                    year: "numeric",
                    month: "short",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                  })}
                </div>
              </div>
            </div>

            <aside className="h-fit rounded-2xl border border-slate-200 bg-white p-5">
              <div className="text-xs font-semibold text-slate-600">Price</div>
              <div className="mt-1 text-3xl font-extrabold text-slate-900">{centsToDollars(item.priceCents)}</div>

              <div className="mt-4 rounded-xl bg-slate-50 p-4">
                <div className="text-sm font-bold text-slate-900">Contact seller</div>

                {item.contact ? (
                  <div className="mt-2 whitespace-pre-wrap text-sm font-semibold text-slate-800">{item.contact}</div>
                ) : (
                  <div className="mt-1 text-sm text-slate-700">Seller didnâ€™t provide contact info.</div>
                )}
              </div>

              <Link
                to="/post"
                className="mt-4 block w-full rounded-2xl bg-slate-900 px-4 py-3 text-center text-sm font-semibold text-white hover:bg-slate-800"
              >
                Post your own listing
              </Link>
            </aside>
          </div>
        )}
      </main>

      {/* Lightbox */}
      {lightboxOpen && (
        <div
          className="fixed inset-0 z-50 bg-black/80 backdrop-blur-[2px]"
          onMouseDown={(e) => {
            // close when clicking the backdrop (but not when clicking the image/content)
            if (e.target === e.currentTarget) closeLightbox();
          }}
          aria-modal="true"
          role="dialog"
        >
          <div className="absolute inset-0 flex items-center justify-center p-4">
            {/* Content */}
            <div className="relative w-full max-w-6xl">
              {/* Close button */}
              <button
                type="button"
                onClick={closeLightbox}
                aria-label="Close"
                className="
                  absolute right-2 top-2 z-10
                  rounded-full border border-white/30
                  bg-white/10 backdrop-blur
                  px-3 py-2
                  text-white
                  shadow-sm
                  transition
                  hover:bg-white/20 hover:border-white/50
                  focus:outline-none
                  focus-visible:ring-2 focus-visible:ring-white/60
                "
              >
                âœ•
              </button>

              {/* Counter */}
              {assets.length > 0 && (
                <div className="absolute left-2 top-2 z-10 rounded-full border border-white/20 bg-white/10 px-3 py-2 text-xs font-semibold text-white backdrop-blur">
                  {active + 1} / {assets.length}
                </div>
              )}

              {/* Image */}
              <div className="relative overflow-hidden rounded-2xl">
                <div className="flex items-center justify-center">
                  {fullRes ? (
                    <img
                      src={fullRes}
                      alt={item?.title ?? "Listing image"}
                      className="max-h-[85vh] w-auto max-w-full select-none object-contain"
                      draggable={false}
                    />
                  ) : (
                    <div className="flex h-[60vh] w-full items-center justify-center rounded-2xl bg-white/10 text-sm font-semibold text-white">
                      No image
                    </div>
                  )}
                </div>

                {/* Arrows inside lightbox */}
                {hasMultiple && (
                  <>
                    <button
                      type="button"
                      onClick={prevImage}
                      aria-label="Previous image"
                      className="
                        absolute left-3 top-1/2 -translate-y-1/2
                        rounded-full border border-white/30
                        bg-white/10 backdrop-blur
                        px-4 py-3
                        text-white
                        shadow-sm
                        transition
                        hover:bg-white/20 hover:border-white/50
                        focus:outline-none
                        focus-visible:ring-2 focus-visible:ring-white/60
                      "
                    >
                      â€¹
                    </button>

                    <button
                      type="button"
                      onClick={nextImage}
                      aria-label="Next image"
                      className="
                        absolute right-3 top-1/2 -translate-y-1/2
                        rounded-full border border-white/30
                        bg-white/10 backdrop-blur
                        px-4 py-3
                        text-white
                        shadow-sm
                        transition
                        hover:bg-white/20 hover:border-white/50
                        focus:outline-none
                        focus-visible:ring-2 focus-visible:ring-white/60
                      "
                    >
                      â€º
                    </button>
                  </>
                )}
              </div>

              {/* Hint */}
              <div className="mt-3 text-center text-xs font-semibold text-white/70">
                {hasMultiple ? "Use â† / â†’ to navigate, Esc to close" : "Press Esc to close"}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

@@@

@@@frontend\src\pages\LoginPage.tsx
import { useState } from "react";
import { useNavigate } from "react-router-dom";

type Props = {
  onBack: () => void;
};

export default function LoginPage() {
  const navigate = useNavigate();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    // Placeholder â€“ hook backend auth later
    alert(`Login attempted for ${email}`);
  }

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center px-6">
      <div className="w-full max-w-md rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <h1 className="text-2xl font-extrabold tracking-tight text-slate-900">
          Login
        </h1>
        <p className="mt-1 text-sm text-slate-600">
          Sign in to manage your listings
        </p>

        <form onSubmit={onSubmit} className="mt-6 grid gap-4">
          <input
            type="email"
            required
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Email address"
            className="rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
          />

          <input
            type="password"
            required
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="Password"
            className="rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
          />

          <button
            type="submit"
            className="mt-2 rounded-xl border border-slate-900 bg-slate-900 px-4 py-3 text-sm font-extrabold text-white hover:bg-slate-800"
          >
            Login
          </button>
        </form>

        <div className="mt-6 flex items-center justify-between text-sm">
          <button
            onClick={() => navigate("/")}
            className="font-semibold text-slate-600 hover:text-slate-900"
            >
                â† Back to home
            </button>
          <button
            type="button"
            className="font-semibold text-cyan-700 hover:text-cyan-900"
          >
            Create account
          </button>
        </div>
      </div>
    </div>
  );
}

@@@

@@@frontend\src\pages\MyListingsPage.tsx
import { useEffect, useMemo, useState } from "react";
import { Link } from "react-router-dom";
import {
  deleteListing,
  fetchListing,
  listOwnedIds,
  removeOwnerToken,
  resolveAssets,
  pauseListing,
  resumeListing,
  markSold,
  type Listing,
} from "../api";

function centsToDollars(cents: number) {
  return (cents / 100).toLocaleString(undefined, { style: "currency", currency: "AUD" });
}

type Row = { id: string; listing?: Listing; error?: string };

function badgeText(l: Listing) {
  const bits: string[] = [];
  bits.push(l.status);
  if (l.resolution !== "none") bits.push(l.resolution);
  return bits.join(" â€¢ ");
}

function Badge({ l }: { l: Listing }) {
  const s = l.status;
  const r = l.resolution;

  const cls =
    r !== "none"
      ? "bg-slate-100 text-slate-800 border-slate-200"
      : s === "active"
      ? "bg-emerald-50 text-emerald-800 border-emerald-200"
      : s === "pending"
      ? "bg-amber-50 text-amber-900 border-amber-200"
      : s === "paused"
      ? "bg-violet-50 text-violet-900 border-violet-200"
      : s === "expired"
      ? "bg-slate-50 text-slate-700 border-slate-200"
      : s === "draft"
      ? "bg-sky-50 text-sky-900 border-sky-200"
      : "bg-slate-50 text-slate-700 border-slate-200";

  return <span className={`inline-flex items-center rounded-full border px-2 py-1 text-[11px] font-bold ${cls}`}>{badgeText(l)}</span>;
}

function IconButton(props: {
  title: string;
  onClick?: () => void;
  disabled?: boolean;
  variant?: "default" | "danger" | "primary";
  children: React.ReactNode;
}) {
  const { title, onClick, disabled, variant = "default", children } = props;

  const base =
    "inline-flex items-center justify-center rounded-xl border p-2 transition focus:outline-none focus-visible:ring-2";
  const cls =
    variant === "danger"
      ? "border-red-200 bg-white text-red-700 hover:bg-red-50 focus-visible:ring-red-300 disabled:opacity-60"
      : variant === "primary"
      ? "border-slate-900 bg-slate-900 text-white hover:bg-slate-800 focus-visible:ring-slate-400 disabled:opacity-60"
      : "border-slate-200 bg-white text-slate-900 hover:bg-slate-50 focus-visible:ring-slate-300 disabled:opacity-60";

  return (
    <button type="button" title={title} aria-label={title} onClick={onClick} disabled={disabled} className={`${base} ${cls}`}>
      {children}
    </button>
  );
}

function IconPencil() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M3 17.25V21h3.75L19.81 7.94l-3.75-3.75L3 17.25zm2.92 2.83H5v-.92l11.06-11.06.92.92L5.92 20.08zM20.71 6.04a1 1 0 0 0 0-1.41l-1.34-1.34a1 1 0 0 0-1.41 0l-1.13 1.13 3.75 3.75 1.13-1.13z"
        fill="currentColor"
      />
    </svg>
  );
}

function IconTrash() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M9 3h6l1 2h5v2H3V5h5l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9z"
        fill="currentColor"
      />
    </svg>
  );
}

function IconPause() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M7 5h3v14H7V5zm7 0h3v14h-3V5z" fill="currentColor" />
    </svg>
  );
}

function IconPlay() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M8 5v14l11-7L8 5z" fill="currentColor" />
    </svg>
  );
}

function IconCheck() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M9.2 16.2 4.8 11.8l1.4-1.4 3 3 8.6-8.6 1.4 1.4-10 10z"
        fill="currentColor"
      />
    </svg>
  );
}

export default function MyListingsPage() {
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const ownedIds = useMemo(() => listOwnedIds(), []);

  useEffect(() => {
    let cancelled = false;
    async function run() {
      setErr(null);
      setLoading(true);
      try {
        const ids = listOwnedIds();
        const next: Row[] = [];

        for (const id of ids) {
          try {
            const l = await fetchListing(id);
            next.push({ id, listing: l });
          } catch (e: any) {
            next.push({ id, error: e?.message ?? "Failed to load listing" });
          }
        }

        if (!cancelled) setRows(next);
      } catch (e: any) {
        if (!cancelled) setErr(e?.message ?? "Failed to load your listings");
      } finally {
        if (!cancelled) setLoading(false);
      }
    }
    run();
    return () => {
      cancelled = true;
    };
  }, []);

  async function onDelete(id: string) {
    setErr(null);
    const ok = window.confirm("Delete this listing? This cannot be undone.");
    if (!ok) return;

    try {
      await deleteListing(id);
      removeOwnerToken(id);
      setRows((prev) => prev.filter((r) => r.id !== id));
    } catch (e: any) {
      setErr(e?.message ?? "Delete failed");
    }
  }

  async function doTogglePauseResume(l: Listing) {
    setErr(null);
    try {
      const updated = l.status === "paused" ? await resumeListing(l.id) : await pauseListing(l.id);
      setRows((prev) => prev.map((r) => (r.id === l.id ? { ...r, listing: updated } : r)));
    } catch (e: any) {
      setErr(e?.message ?? "Failed to update listing status");
    }
  }

  async function doSold(id: string) {
    setErr(null);
    const ok = window.confirm("Mark this listing as SOLD? It will be hidden from Browse.");
    if (!ok) return;

    try {
      const updated = await markSold(id);
      setRows((prev) => prev.map((r) => (r.id === id ? { ...r, listing: updated } : r)));
    } catch (e: any) {
      setErr(e?.message ?? "Failed to mark sold");
    }
  }

  return (
    <div className="min-h-full">
      <header className="border-b border-slate-200 bg-white">
        <div className="mx-auto flex max-w-5xl items-center justify-between px-4 py-3">
          <Link to="/" className="font-extrabold tracking-tight text-slate-900">
            Fishclassifieds
          </Link>
          <div className="flex items-center gap-3">
            <Link to="/post" className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
              Post a listing
            </Link>
            <Link to="/" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              Browse
            </Link>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-5xl px-4 py-6">
        <h1 className="text-xl font-extrabold text-slate-900">My listings</h1>
        <div className="mt-1 text-sm text-slate-600">Listings created on this device.</div>

        {err && <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">{err}</div>}
        {loading && <div className="mt-4 text-sm text-slate-600">Loading...</div>}

        {!loading && ownedIds.length === 0 && (
          <div className="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
            <div className="text-sm font-semibold text-slate-900">No listings yet</div>
            <div className="mt-1 text-sm text-slate-600">Post one and it will show here.</div>
            <Link to="/post" className="mt-4 inline-block rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">
              Post a listing
            </Link>
          </div>
        )}

        <div className="mt-6 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {rows.map((r) => {
            const l = r.listing;
            if (!l) {
              return (
                <div key={r.id} className="rounded-2xl border border-slate-200 bg-white p-4">
                  <div className="text-sm font-bold text-slate-900">Listing {r.id}</div>
                  <div className="mt-1 text-sm text-slate-700">{r.error ?? "Unavailable"}</div>
                  <div className="mt-3 flex gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        removeOwnerToken(r.id);
                        setRows((prev) => prev.filter((x) => x.id !== r.id));
                      }}
                      className="rounded-xl border border-slate-200 px-3 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50"
                    >
                      Remove from My Listings
                    </button>
                  </div>
                </div>
              );
            }

            const assets = resolveAssets(l.images ?? []);
            const hero = assets[0]?.thumbUrl ?? assets[0]?.url ?? null;

            const canToggle = l.status !== "expired" && l.status !== "deleted" && l.status !== "draft" && l.resolution === "none";
            const canResolve = l.status !== "expired" && l.status !== "deleted" && l.resolution === "none";

            const toggleTitle = l.status === "paused" ? "Resume" : "Pause";

            return (
              <div key={l.id} className="overflow-hidden rounded-2xl border border-slate-200 bg-white">
                <Link to={`/listing/${l.id}`} className="block">
                  <div className="aspect-[4/3] w-full bg-slate-100">
                    {hero ? (
                      <img src={hero} alt={l.title} className="h-full w-full object-cover" />
                    ) : (
                      <div className="flex h-full w-full items-center justify-center text-xs font-semibold text-slate-500">No image</div>
                    )}
                  </div>
                </Link>

                <div className="p-4">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="truncate text-sm font-extrabold text-slate-900">{l.title}</div>
                      <div className="mt-1 truncate text-xs font-semibold text-slate-600">
                        {l.category} â€¢ {l.species} â€¢ {l.location}
                      </div>
                    </div>
                    <Badge l={l} />
                  </div>

                  <div className="mt-3 flex items-center justify-between">
                    <div className="text-sm font-extrabold text-slate-900">{centsToDollars(l.priceCents)}</div>
                    <div className="text-[11px] font-semibold text-slate-500">{new Date(l.createdAt).toLocaleDateString()}</div>
                  </div>

                  {/* Icon action row: Edit, Delete, Pause/Resume, Sold */}
                  <div className="mt-4 flex items-center gap-2">
                    <Link to={`/edit/${l.id}`} className="inline-flex" aria-label="Edit">
                      <IconButton title="Edit" variant="default">
                        <IconPencil />
                      </IconButton>
                    </Link>

                    <IconButton title="Delete" variant="danger" onClick={() => onDelete(l.id)}>
                      <IconTrash />
                    </IconButton>

                    <IconButton
                      title={toggleTitle}
                      variant="default"
                      disabled={!canToggle}
                      onClick={() => doTogglePauseResume(l)}
                    >
                      {l.status === "paused" ? <IconPlay /> : <IconPause />}
                    </IconButton>

                    <IconButton title="Mark as Sold" variant="primary" disabled={!canResolve} onClick={() => doSold(l.id)}>
                      <IconCheck />
                    </IconButton>
                  </div>

                  <div className="mt-3 text-[11px] font-semibold text-slate-500">
                    Updated: {new Date(l.updatedAt).toLocaleString()}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </main>
    </div>
  );
}

@@@

@@@frontend\src\pages\PostListingPage.tsx
import { useEffect, useMemo, useState } from "react";
import { Link, useNavigate } from "react-router-dom";
import {
  createListing,
  uploadImage,
  resolveImageUrl,
  setOwnerToken,
  type Category,
  type ImageAsset,
} from "../api";

function dollarsToCents(v: string) {
  const n = Number(v);
  if (!Number.isFinite(n) || n < 0) return null;
  return Math.round(n * 100);
}

const CATEGORIES: Category[] = ["Fish", "Shrimp", "Snails", "Plants", "Equipment"];

type PendingImage = {
  id: string;
  file: File;
  uploaded?: ImageAsset;
  status: "ready" | "uploading" | "uploaded" | "error";
  error?: string;
};

function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

export default function PostListingPage() {
  const nav = useNavigate();

  const [title, setTitle] = useState("");
  const [category, setCategory] = useState<Category>("Fish");
  const [species, setSpecies] = useState("");
  const [priceDollars, setPriceDollars] = useState("");
  const [location, setLocation] = useState("");
  const [contact, setContact] = useState("");
  const [description, setDescription] = useState("");

  const [imgs, setImgs] = useState<PendingImage[]>([]);
  const [uploading, setUploading] = useState(false);

  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  function removeImg(id: string) {
    setImgs((prev) => prev.filter((x) => x.id !== id));
  }

  function moveImg(id: string, dir: -1 | 1) {
    setImgs((prev) => {
      const i = prev.findIndex((x) => x.id === id);
      if (i < 0) return prev;
      const j = i + dir;
      if (j < 0 || j >= prev.length) return prev;
      const copy = [...prev];
      const tmp = copy[i];
      copy[i] = copy[j];
      copy[j] = tmp;
      return copy;
    });
  }

  function onPickFiles(nextFiles: FileList | null) {
    setErr(null);
    if (!nextFiles) return;

    setImgs((prev) => {
      const room = Math.max(0, 6 - prev.length);
      const picked = Array.from(nextFiles).slice(0, room);
      if (!picked.length) return prev;

      return [
        ...prev,
        ...picked.map((f) => ({
          id: uid(),
          file: f,
          status: "ready" as const,
        })),
      ];
    });
  }

  const previews = useMemo(() => {
    return imgs.map((img) => {
      const resolvedThumb =
        img.uploaded?.thumbUrl ? resolveImageUrl(img.uploaded.thumbUrl) : null;
      const resolvedUrl =
        img.uploaded?.url ? resolveImageUrl(img.uploaded.url) : null;

      return {
        id: img.id,
        status: img.status,
        error: img.error,
        src: resolvedThumb || resolvedUrl || URL.createObjectURL(img.file),
        uploaded: !!img.uploaded,
        local: !img.uploaded,
      };
    });
  }, [imgs]);

  useEffect(() => {
    const locals = previews.filter((p) => p.local).map((p) => p.src);
    return () => {
      for (const u of locals) URL.revokeObjectURL(u);
    };
  }, [previews]);

  async function uploadOne(img: PendingImage) {
    setImgs((prev) => prev.map((x) => (x.id === img.id ? { ...x, status: "uploading", error: undefined } : x)));

    try {
      const asset = await uploadImage(img.file);
      setImgs((prev) => prev.map((x) => (x.id === img.id ? { ...x, status: "uploaded", uploaded: asset } : x)));
      return asset;
    } catch (e: any) {
      const msg = e?.message ?? "Upload failed";
      setImgs((prev) => prev.map((x) => (x.id === img.id ? { ...x, status: "error", error: msg } : x)));
      throw new Error(msg);
    }
  }

  async function doUploadAll() {
    if (!imgs.length) return;

    setErr(null);
    setUploading(true);
    try {
      for (const img of imgs) {
        if (img.status === "uploaded" && img.uploaded) continue;
        await uploadOne(img).catch(() => {});
      }
    } finally {
      setUploading(false);
    }
  }

  async function retryUpload(id: string) {
    const img = imgs.find((x) => x.id === id);
    if (!img) return;
    setErr(null);
    setUploading(true);
    try {
      await uploadOne(img);
    } catch {
      // handled per image
    } finally {
      setUploading(false);
    }
  }

  const canSubmit = !loading && !uploading && !imgs.some((i) => i.status === "uploading");

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);

    const priceCents = dollarsToCents(priceDollars);
    if (priceCents === null) {
      setErr("Please enter a valid non-negative price.");
      return;
    }

    setLoading(true);
    try {
      if (imgs.some((i) => i.status !== "uploaded")) {
        await doUploadAll();
      }

      const uploadedAssets = imgs
        .filter((i) => i.status === "uploaded" && i.uploaded)
        .map((i) => i.uploaded!)
        .slice(0, 6);

      if (imgs.length > 0 && uploadedAssets.length === 0) {
        throw new Error("Images were selected but none uploaded successfully. Remove broken images or retry upload.");
      }

      const created = await createListing({
        title: title.trim(),
        category,
        species: species.trim(),
        priceCents,
        location: location.trim(),
        description: description.trim(),
        contact: contact.trim() ? contact.trim() : null,
        images: uploadedAssets,
      });

      setOwnerToken(created.id, created.ownerToken);
      nav(`/listing/${created.id}`);
    } catch (e: any) {
      setErr(e?.message ?? "Failed to post listing");
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="min-h-full">
      <header className="border-b border-slate-200 bg-white">
        <div className="mx-auto flex max-w-3xl items-center justify-between px-4 py-3">
          <Link to="/" className="font-extrabold tracking-tight text-slate-900">
            Fishclassifieds
          </Link>

          <div className="flex items-center gap-3">
            <Link to="/me" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              My listings
            </Link>
            <Link to="/" className="text-sm font-semibold text-slate-700 hover:text-slate-900">
              Browse
            </Link>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-3xl px-4 py-6">
        <h1 className="text-2xl font-extrabold text-slate-900">Post a listing</h1>
        <div className="mt-1 text-sm text-slate-600">Add up to 6 photos.</div>

        {err && (
          <div className="mt-4 rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700">{err}</div>
        )}

        <form onSubmit={onSubmit} className="mt-6 space-y-4 rounded-2xl border border-slate-200 bg-white p-5">
          {/* Images */}
          <div className="rounded-2xl border border-slate-200 p-4">
            <div className="flex items-center justify-between gap-3">
              <div>
                <div className="text-sm font-bold text-slate-900">Photos</div>
                <div className="text-xs text-slate-600">JPG / PNG / WebP up to 6MB each</div>
              </div>

              <div className="flex items-center gap-2">
                <label className="cursor-pointer rounded-2xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50">
                  Choose
                  <input
                    type="file"
                    multiple
                    accept="image/jpeg,image/png,image/webp"
                    className="hidden"
                    onChange={(e) => onPickFiles(e.target.files)}
                  />
                </label>

                <button
                  type="button"
                  onClick={doUploadAll}
                  disabled={!imgs.length || uploading}
                  className="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60"
                >
                  {uploading ? "Uploadingâ€¦" : imgs.length && imgs.every((i) => i.status === "uploaded") ? "Uploaded" : "Upload"}
                </button>
              </div>
            </div>

            <div className="mt-4 grid gap-3 sm:grid-cols-3">
              {previews.length ? (
                previews.map((p, idx) => (
                  <div key={p.id} className="overflow-hidden rounded-2xl border border-slate-200 bg-white">
                    <div className="relative h-28 w-full bg-slate-100">
                      <img src={p.src} alt={`preview-${idx}`} className="h-full w-full object-cover" loading="lazy" decoding="async" />

                      <div className="absolute left-2 top-2 flex gap-1">
                        <button
                          type="button"
                          onClick={() => moveImg(p.id, -1)}
                          disabled={idx === 0}
                          className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                          title="Move left"
                        >
                          â†
                        </button>
                        <button
                          type="button"
                          onClick={() => moveImg(p.id, 1)}
                          disabled={idx === previews.length - 1}
                          className="rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 disabled:opacity-50"
                          title="Move right"
                        >
                          â†’
                        </button>
                      </div>

                      <button
                        type="button"
                        onClick={() => removeImg(p.id)}
                        className="absolute right-2 top-2 rounded-lg bg-white/90 px-2 py-1 text-xs font-semibold text-slate-900 hover:bg-white"
                        title="Remove"
                      >
                        âœ–
                      </button>

                      <div className="absolute bottom-2 left-2 flex items-center gap-2">
                        <div className="rounded-lg bg-white/90 px-2 py-1 text-[11px] font-semibold text-slate-700">
                          {p.status === "uploading" ? "Uploadingâ€¦" : p.status === "uploaded" ? "Uploaded" : p.status === "error" ? "Error" : "Ready"}
                        </div>

                        {p.status === "error" && (
                          <button
                            type="button"
                            onClick={() => retryUpload(p.id)}
                            disabled={uploading}
                            className="rounded-lg bg-white/90 px-2 py-1 text-[11px] font-semibold text-slate-900 hover:bg-white disabled:opacity-60"
                          >
                            Retry
                          </button>
                        )}
                      </div>
                    </div>

                    {p.status === "error" && p.error && (
                      <div className="border-t border-red-100 bg-red-50 px-3 py-2 text-xs font-semibold text-red-700">
                        {p.error}
                      </div>
                    )}
                  </div>
                ))
              ) : (
                <div className="col-span-full flex h-28 items-center justify-center rounded-2xl bg-slate-100 text-sm font-semibold text-slate-500">
                  No images selected
                </div>
              )}
            </div>

            <div className="mt-3 text-xs text-slate-600">
              Tip: the first photo becomes the thumbnail on the homepage.
            </div>
          </div>

          {/* Fields */}
          <label className="block">
            <div className="mb-1 text-xs font-semibold text-slate-700">Title</div>
            <input
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
              required
              minLength={3}
              maxLength={80}
            />
          </label>

          <div className="grid gap-3 sm:grid-cols-2">
            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Category</div>
              <select
                value={category}
                onChange={(e) => setCategory(e.target.value as Category)}
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
              >
                {CATEGORIES.map((c) => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </label>

            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Species</div>
              <input
                value={species}
                onChange={(e) => setSpecies(e.target.value)}
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                required
                minLength={2}
                maxLength={60}
              />
            </label>
          </div>

          <div className="grid gap-3 sm:grid-cols-2">
            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Price ($)</div>
              <input
                value={priceDollars}
                onChange={(e) => setPriceDollars(e.target.value)}
                inputMode="decimal"
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                required
              />
            </label>

            <label className="block">
              <div className="mb-1 text-xs font-semibold text-slate-700">Location</div>
              <input
                value={location}
                onChange={(e) => setLocation(e.target.value)}
                className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
                required
                minLength={2}
                maxLength={80}
              />
            </label>
          </div>

          <label className="block">
            <div className="mb-1 text-xs font-semibold text-slate-700">Contact (optional)</div>
            <input
              value={contact}
              onChange={(e) => setContact(e.target.value)}
              placeholder="e.g. phone, email, or 'DM on FB: â€¦'"
              className="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
              maxLength={200}
            />
          </label>

          <label className="block">
            <div className="mb-1 text-xs font-semibold text-slate-700">Description</div>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="min-h-[140px] w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:border-slate-400"
              required
              minLength={1}
              maxLength={1000}
            />
          </label>

          <button
            type="submit"
            disabled={!canSubmit}
            className="w-full rounded-2xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60"
          >
            {loading ? "Postingâ€¦" : uploading ? "Uploadingâ€¦" : "Post listing"}
          </button>

          {imgs.some((i) => i.status === "error") && (
            <div className="text-xs font-semibold text-slate-600">
              Some images failed to upload. You can remove them or press â€œRetryâ€ on each.
            </div>
          )}
        </form>
      </main>
    </div>
  );
}

@@@

@@@frontend\src\pages\SignUpPage.tsx
import { useMemo, useState } from "react";
import { useNavigate } from "react-router-dom";

export default function SignUpPage() {
  const navigate = useNavigate();

  const [email, setEmail] = useState("");
  const [firstName, setFirstName] = useState("");
  const [surname, setSurname] = useState("");
  const [username, setUsername] = useState("");

  const [password, setPassword] = useState("");
  const [confirm, setConfirm] = useState("");

  const [agree, setAgree] = useState(false);
  const [newsletter, setNewsletter] = useState(true);

  const emailOk = useMemo(
    () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim()),
    [email]
  );

  const usernameOk = useMemo(
    () => /^[a-zA-Z0-9_]{3,20}$/.test(username),
    [username]
  );

  const pwOk = useMemo(() => password.length >= 8, [password]);
  const matchOk = useMemo(() => password === confirm && confirm.length > 0, [password, confirm]);

  const canSubmit =
    emailOk &&
    firstName.trim().length >= 2 &&
    surname.trim().length >= 2 &&
    usernameOk &&
    pwOk &&
    matchOk &&
    agree;

  function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!canSubmit) return;

    // TODO: POST /api/auth/signup
    alert("Account creation (stub). Wire to backend next.");
  }

  return (
    <div className="min-h-screen bg-slate-50">
      <header className="border-b border-slate-200 bg-white">
        <div className="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
          <button
            onClick={() => navigate("/")}
            className="text-sm font-semibold text-slate-600 hover:text-slate-900"
          >
            â† Back to home
          </button>

          <div className="text-sm text-slate-600">
            Already have an account?{" "}
            <button
              onClick={() => navigate("/login")}
              className="font-semibold text-slate-900 underline underline-offset-4"
            >
              Login
            </button>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-6xl px-6 py-10">
        <div className="mx-auto max-w-xl rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
          <h1 className="text-2xl font-extrabold tracking-tight text-slate-900">
            Create your account
          </h1>
          <p className="mt-2 text-sm text-slate-600">
            Create an account to post listings, contact sellers, and manage your ads.
          </p>

          <form onSubmit={onSubmit} className="mt-6 grid gap-4">
            {/* Email */}
            <div>
              <label className="text-sm font-semibold text-slate-800">Email</label>
              <p className="mt-1 text-xs text-slate-500">
                Used for login and important account notifications.
              </p>
              <input
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                type="email"
                placeholder="you@example.com"
                className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
              />
              {!emailOk && email && (
                <div className="mt-1 text-xs text-red-700">
                  Enter a valid email address.
                </div>
              )}
            </div>

            {/* First + Surname */}
            <div className="grid grid-cols-1 gap-3 md:grid-cols-2">
              <div>
                <label className="text-sm font-semibold text-slate-800">First name</label>
                <input
                  value={firstName}
                  onChange={(e) => setFirstName(e.target.value)}
                  placeholder="First name"
                  className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
                />
              </div>

              <div>
                <label className="text-sm font-semibold text-slate-800">Surname</label>
                <input
                  value={surname}
                  onChange={(e) => setSurname(e.target.value)}
                  placeholder="Surname"
                  className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
                />
              </div>
            </div>

            {/* Username */}
            <div>
              <label className="text-sm font-semibold text-slate-800">Username</label>
              <p className="mt-1 text-xs text-slate-500">
                This is public and <span className="font-semibold">cannot be changed later</span>.
                Letters, numbers, and underscores only.
              </p>
              <input
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                placeholder="e.g. reef_keeper92"
                className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
              />
              {!usernameOk && username && (
                <div className="mt-1 text-xs text-red-700">
                  3â€“20 characters. Letters, numbers, underscores only.
                </div>
              )}
            </div>

            {/* Password */}
            <div>
              <label className="text-sm font-semibold text-slate-800">Password</label>
              <p className="mt-1 text-xs text-slate-500">
                Minimum 8 characters. Use a strong, unique password.
              </p>
              <input
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                type="password"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
              />
            </div>

            {/* Confirm */}
            <div>
              <label className="text-sm font-semibold text-slate-800">Confirm password</label>
              <input
                value={confirm}
                onChange={(e) => setConfirm(e.target.value)}
                type="password"
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                className="mt-2 w-full rounded-xl border border-slate-200 px-3 py-3 text-sm outline-none focus:border-slate-900"
              />
              {!matchOk && confirm && (
                <div className="mt-1 text-xs text-red-700">Passwords do not match.</div>
              )}
            </div>

            {/* Agreements */}
            <div className="rounded-xl border border-slate-200 bg-slate-50 p-4">
              <label className="flex gap-3 text-sm text-slate-700">
                <input
                  type="checkbox"
                  checked={agree}
                  onChange={(e) => setAgree(e.target.checked)}
                  className="mt-1"
                />
                <span>
                  I agree to the <strong>Terms of Service</strong> and{" "}
                  <strong>Privacy Policy</strong>.
                </span>
              </label>

              <label className="mt-3 flex gap-3 text-sm text-slate-700">
                <input
                  type="checkbox"
                  checked={newsletter}
                  onChange={(e) => setNewsletter(e.target.checked)}
                  className="mt-1"
                />
                <span>
                  Send me occasional updates and announcements (optional).
                </span>
              </label>
            </div>

            <button
              type="submit"
              disabled={!canSubmit}
              className={[
                "rounded-xl border px-4 py-3 text-sm font-extrabold transition",
                canSubmit
                  ? "border-slate-900 bg-slate-900 text-white hover:bg-slate-800"
                  : "cursor-not-allowed border-slate-200 bg-slate-100 text-slate-500"
              ].join(" ")}
            >
              Create account
            </button>
          </form>
        </div>
      </main>
    </div>
  );
}

@@@

